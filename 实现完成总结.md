# âœ… Universal Identity System å®ç°å®Œæˆæ€»ç»“

## ğŸ“‹ å·²å®Œæˆçš„åŠŸèƒ½

### 1. âœ… IdentityServiceï¼ˆå¤šå¹³å°èº«ä»½è®¤è¯æœåŠ¡ï¼‰
**æ–‡ä»¶**: `api/services/identity_service.py`

**åŠŸèƒ½**:
- `get_or_create_user_by_identity()` - é€šè¿‡èº«ä»½æä¾›è€…è·å–æˆ–åˆ›å»ºç”¨æˆ·
  - æ”¯æŒ: Telegram, Google, Wallet, Email
  - è‡ªåŠ¨åˆ›å»ºUserIdentityè®°å½•
  - è‡ªåŠ¨ç”ŸæˆUUID
- `link_identity()` - é“¾æ¥æ–°èº«ä»½åˆ°ç°æœ‰ç”¨æˆ·
- `generate_magic_link()` - ç”ŸæˆMagic Linkï¼ˆè·¨å¹³å°ç™»å½•ï¼‰
- `verify_magic_link()` - éªŒè¯Magic Link
- `get_user_identities()` - è·å–ç”¨æˆ·æ‰€æœ‰èº«ä»½
- `get_user_by_telegram_id()` - å…¼å®¹æ—§ä»£ç çš„Telegramç”¨æˆ·æŸ¥æ‰¾

---

### 2. âœ… Webè®¤è¯APIè·¯ç”±
**æ–‡ä»¶**: 
- `api/routers/auth/web.py` - Google OAuthå’ŒWalletè¿æ¥
- `api/routers/auth/link.py` - Magic Linkç”Ÿæˆå’ŒéªŒè¯

**APIç«¯ç‚¹**:
- `POST /api/v1/auth/web/google` - Googleç™»å½•
- `POST /api/v1/auth/web/wallet` - Walletè¿æ¥
- `POST /api/v1/auth/link/magic-link/generate` - ç”ŸæˆMagic Linkï¼ˆéœ€è¦Telegramè®¤è¯ï¼‰
- `POST /api/v1/auth/link/magic-link/verify` - éªŒè¯Magic Link
- `GET /api/v1/auth/link/identities` - è·å–ç”¨æˆ·æ‰€æœ‰èº«ä»½

**æ³¨æ„**: Google OAuthå’ŒWalletç­¾åéªŒè¯ç›®å‰æ˜¯Mockç‰ˆæœ¬ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦å®ç°çœŸå®éªŒè¯ã€‚

---

### 3. âœ… å‰ç«¯AuthGuardç»„ä»¶
**æ–‡ä»¶**:
- `frontend/src/utils/platform.ts` - å¹³å°æ£€æµ‹å·¥å…·
- `frontend/src/utils/auth/useAuth.ts` - è®¤è¯Hook
- `frontend/src/utils/auth/AuthGuard.tsx` - è®¤è¯å®ˆå«ç»„ä»¶
- `frontend/src/components/WebLoginScreen.tsx` - Webç™»å½•ç•Œé¢

**åŠŸèƒ½**:
- è‡ªåŠ¨æ£€æµ‹å¹³å°ï¼ˆTelegram/Web/iOS/Androidï¼‰
- Telegramç¯å¢ƒï¼šè‡ªåŠ¨ç™»å½•ï¼ˆä½¿ç”¨initDataï¼‰
- Webç¯å¢ƒï¼šæ˜¾ç¤ºç™»å½•é€‰é¡¹ï¼ˆGoogle/Wallet/Magic Linkï¼‰
- ç»Ÿä¸€ç”¨æˆ·çŠ¶æ€ç®¡ç†
- å¹³å°è§„åˆ™æ£€æµ‹ï¼ˆç”¨äºåˆè§„ï¼Œå¦‚iOSéšè—é‡‘èåŠŸèƒ½ï¼‰

**APIå®¢æˆ·ç«¯æ›´æ–°**:
- `frontend/src/utils/api.ts` - æ·»åŠ äº†Webè®¤è¯ç›¸å…³APIæ–¹æ³•

---

### 4. âœ… LedgerServiceé›†æˆ
**å·²æ›¿æ¢çš„API**:
- âœ… `api/routers/redpackets.py` - `create_red_packet()` - å‘é€çº¢åŒ…æ—¶æ‰£é™¤ä½™é¢
- âœ… `api/routers/redpackets.py` - `claim_red_packet()` - é¢†å–çº¢åŒ…æ—¶å¢åŠ ä½™é¢ï¼ˆå«çº¢åŒ…ç‚¸å¼¹æƒ©ç½šï¼‰
- âœ… `api/routers/checkin.py` - `do_checkin()` - ç­¾åˆ°å¥–åŠ±

**æ”¹è¿›**:
- æ‰€æœ‰ä½™é¢æ“ä½œéƒ½é€šè¿‡LedgerServiceåˆ›å»ºè´¦æœ¬æ¡ç›®
- æ”¯æŒä½™é¢å¿«ç…§ï¼ˆbalance_before, balance_afterï¼‰
- æ”¯æŒå…³è”è®°å½•ï¼ˆrelated_type, related_idï¼‰
- æ”¯æŒå…ƒæ•°æ®ï¼ˆmetadata, descriptionï¼‰

---

## ğŸ”§ æ•°æ®åº“æ¨¡å‹æ›´æ–°

### æ–°å¢æ¨¡å‹
- âœ… `UserIdentity` - ç”¨æˆ·èº«ä»½å…³è”è¡¨
- âœ… `AccountLink` - è´¦æˆ·é“¾æ¥è¡¨ï¼ˆMagic Linkï¼‰

### æ›´æ–°çš„æ¨¡å‹
- âœ… `User` - æ·»åŠ äº†uuid, wallet_address, referrer_idç­‰å­—æ®µ
- âœ… `LedgerEntry` - å…¼å®¹æ–°æ—§å­—æ®µï¼Œæ”¯æŒæ–°æ¶æ„
- âœ… `UserBalance` - æ”¯æŒå¤šå¸ç§ä½™é¢

---

## ğŸ“ å¾…å®Œæˆçš„å·¥ä½œ

### é«˜ä¼˜å…ˆçº§
1. â³ **Redisé«˜å¹¶å‘æŠ¢çº¢åŒ…** - å®ç°Luaè„šæœ¬å¤„ç†10k+å¹¶å‘è¯·æ±‚
2. â³ **PaymentService** - æ”¯ä»˜ç½‘å…³æŠ½è±¡å±‚ï¼ˆUnionPay/Visaç­‰ï¼‰

### ä¸­ä¼˜å…ˆçº§
3. â³ **Google OAuthçœŸå®éªŒè¯** - æ›¿æ¢Mockç‰ˆæœ¬
4. â³ **Walletç­¾åéªŒè¯** - å®ç°çœŸå®éªŒè¯é€»è¾‘
5. â³ **å‰ç«¯AuthGuardé›†æˆ** - åœ¨å®é™…é¡µé¢ä¸­ä½¿ç”¨AuthGuardç»„ä»¶

### ä½ä¼˜å…ˆçº§
6. â³ **æµ‹è¯•è¦†ç›–** - ä¸ºIdentityServiceå’ŒAuth APIç¼–å†™å•å…ƒæµ‹è¯•
7. â³ **æ–‡æ¡£å®Œå–„** - APIæ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•ç°æœ‰åŠŸèƒ½**
   - æµ‹è¯•Telegramç¯å¢ƒä¸‹çš„è®¤è¯
   - æµ‹è¯•Webç¯å¢ƒä¸‹çš„ç™»å½•æµç¨‹
   - æµ‹è¯•Magic Linkç”Ÿæˆå’ŒéªŒè¯

2. **å®ç°Redisé«˜å¹¶å‘æŠ¢çº¢åŒ…**
   - åˆ›å»ºLuaè„šæœ¬å¤„ç†å¹¶å‘æŠ¢çº¢åŒ…
   - ä½¿ç”¨Redis + Queueå¼‚æ­¥åŒæ­¥åˆ°PostgreSQL

3. **å®ç°PaymentService**
   - åˆ›å»ºæ”¯ä»˜ç½‘å…³æŠ½è±¡å±‚
   - å®ç°Mock UnionPay Provider
   - å®ç°è‡ªåŠ¨æ±‡ç‡è½¬æ¢å’Œåˆ©æ¶¦ç‚¹

---

## ğŸ“¦ ä»£ç æäº¤

æ‰€æœ‰ä»£ç å·²æäº¤åˆ°GitHub:
- âœ… IdentityServiceå®ç°
- âœ… Auth APIè·¯ç”±
- âœ… å‰ç«¯AuthGuardç»„ä»¶
- âœ… LedgerServiceé›†æˆ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Redisä¾èµ–**: `LedgerService`ä½¿ç”¨äº†Redisç¼“å­˜ï¼Œä½†Redisæ˜¯å¯é€‰çš„ã€‚å¦‚æœRedisä¸å¯ç”¨ï¼Œä¼šå›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢ã€‚

2. **Google OAuth**: ç›®å‰æ˜¯Mockç‰ˆæœ¬ï¼Œéœ€è¦é›†æˆçœŸå®çš„Google OAuth SDKã€‚

3. **Walletç­¾å**: ç›®å‰æ˜¯Mockç‰ˆæœ¬ï¼Œéœ€è¦å®ç°çœŸå®çš„ç­¾åéªŒè¯é€»è¾‘ã€‚

4. **å‰ç«¯é›†æˆ**: AuthGuardç»„ä»¶å·²åˆ›å»ºï¼Œä½†éœ€è¦åœ¨`App.tsx`ä¸­å®é™…ä½¿ç”¨ã€‚

---

## ğŸ‰ æ€»ç»“

å·²æˆåŠŸå®ç°äº†Universal Identity Systemçš„æ ¸å¿ƒåŠŸèƒ½ï¼š
- âœ… å¤šå¹³å°èº«ä»½è®¤è¯
- âœ… Magic Linkè·¨å¹³å°ç™»å½•
- âœ… Webè®¤è¯API
- âœ… å‰ç«¯AuthGuard
- âœ… LedgerServiceé›†æˆ

ç³»ç»Ÿç°åœ¨æ”¯æŒTelegramç”¨æˆ·å’ŒWebç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªè´¦æˆ·ç³»ç»Ÿï¼


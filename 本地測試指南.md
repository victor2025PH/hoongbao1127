# 本地測試指南 - 消息系統和雙提示功能

## 一、啟動服務

### 1. 啟動後端服務
```powershell
cd api
python main.py
```

後端應該在 `http://localhost:8080` 啟動

### 2. 啟動前端服務
```powershell
cd frontend
npm run dev
```

前端應該在 `http://localhost:3001` 啟動

## 二、測試步驟

### 測試 1: 檢查服務健康狀態

**後端健康檢查：**
```powershell
curl http://localhost:8080/health
```

預期響應：
```json
{
  "status": "ok",
  "app": "Lucky Red",
  "version": "1.0.0"
}
```

**前端訪問：**
打開瀏覽器訪問：`http://localhost:3001`

### 測試 2: 測試消息 API

#### 2.1 獲取未讀消息數量
```powershell
# 需要設置 X-Telegram-Init-Data 頭（本地測試可以使用 tg_id 參數）
curl http://localhost:8080/api/v1/messages/unread-count
```

#### 2.2 獲取消息列表
```powershell
curl http://localhost:8080/api/v1/messages/
```

### 測試 3: 測試 WebSocket 連接

在瀏覽器控制台中測試：

```javascript
// 1. 連接 WebSocket
const ws = new WebSocket('ws://localhost:8080/api/v1/messages/ws?init_data=user%3D%7B%22id%22%3A6359371231%7D')

// 2. 監聽連接
ws.onopen = () => {
  console.log('✅ WebSocket 連接成功')
  // 發送心跳
  ws.send('ping')
}

// 3. 監聽消息
ws.onmessage = (event) => {
  console.log('📨 收到消息:', event.data)
  if (event.data === 'pong') {
    console.log('✅ 心跳響應正常')
  } else {
    const data = JSON.parse(event.data)
    console.log('📬 新消息:', data)
  }
}

// 4. 監聽錯誤
ws.onerror = (error) => {
  console.error('❌ WebSocket 錯誤:', error)
}

// 5. 監聽關閉
ws.onclose = () => {
  console.log('🔌 WebSocket 連接關閉')
}
```

### 測試 4: 測試消息發送（通過後端）

#### 4.1 創建測試消息（需要用戶 ID）
```python
# 在 Python 中執行
from api.services.message_service import MessageService
from shared.database.connection import AsyncSessionLocal
from shared.database.models import MessageType
import asyncio

async def test_send_message():
    async with AsyncSessionLocal() as db:
        service = MessageService(db)
        # 假設用戶 ID 為 1（需要根據實際數據庫調整）
        message = await service.send_message(
            user_id=1,
            message_type=MessageType.SYSTEM,
            content="這是一條測試消息",
            title="測試標題"
        )
        print(f"✅ 消息已發送: {message.id}")

asyncio.run(test_send_message())
```

### 測試 5: 測試前端消息面板

1. **打開前端頁面**：`http://localhost:3001`
2. **點擊右上角星星圖標**：應該打開消息面板
3. **檢查未讀數量徽章**：如果有未讀消息，應該顯示紅色徽章
4. **查看消息列表**：應該顯示所有消息
5. **點擊消息**：應該顯示消息詳情
6. **測試刪除**：點擊刪除按鈕，確認消息被刪除
7. **測試回復**：如果消息支持回復，測試回復功能

### 測試 6: 測試雙提示功能

#### 6.1 測試在 miniapp 中的提示
1. 在瀏覽器中打開前端（模擬在 miniapp 中）
2. 通過後端發送一條消息
3. 應該在前端看到彈窗提示

#### 6.2 測試 Telegram 提示
1. 關閉前端頁面（模擬不在 miniapp 中）
2. 通過後端發送一條消息
3. 應該通過 Telegram Bot 發送消息（需要 Bot Token 配置正確）

### 測試 7: 測試紅包領取通知

1. **創建一個紅包**（通過前端或 API）
2. **領取紅包**
3. **檢查消息**：
   - 應該收到紅包領取通知
   - 應該收到餘額變動通知
   - 在消息面板中應該能看到這兩條消息

## 三、常見問題排查

### 問題 1: 後端無法啟動

**檢查：**
1. Python 環境是否正確
2. 依賴是否安裝：`pip install -r requirements.txt`
3. `.env` 文件是否存在且配置正確
4. 數據庫連接是否正常

**解決：**
```powershell
cd api
pip install -r requirements.txt
python main.py
```

### 問題 2: 前端無法啟動

**檢查：**
1. Node.js 是否安裝
2. 依賴是否安裝：`npm install`
3. 端口 3001 是否被占用

**解決：**
```powershell
cd frontend
npm install
npm run dev
```

### 問題 3: WebSocket 連接失敗

**檢查：**
1. 後端是否正常運行
2. WebSocket 路徑是否正確
3. initData 是否正確傳遞

**解決：**
- 檢查瀏覽器控制台的錯誤信息
- 確認後端日誌中的 WebSocket 連接記錄

### 問題 4: 消息不顯示

**檢查：**
1. 數據庫中是否有消息記錄
2. 用戶 ID 是否正確
3. API 請求是否成功

**解決：**
- 檢查瀏覽器網絡請求
- 檢查後端日誌
- 直接查詢數據庫確認消息是否存在

## 四、測試檢查清單

- [ ] 後端服務正常啟動
- [ ] 前端服務正常啟動
- [ ] WebSocket 連接成功
- [ ] 消息 API 正常響應
- [ ] 消息面板可以打開
- [ ] 未讀數量徽章顯示正確
- [ ] 消息列表可以正常顯示
- [ ] 消息詳情可以查看
- [ ] 消息可以刪除
- [ ] 消息可以回復（如果支持）
- [ ] 紅包領取後收到通知
- [ ] 餘額變動後收到通知
- [ ] 雙提示功能正常（miniapp 和 Telegram）

## 五、調試技巧

### 查看後端日誌
後端啟動後，所有日誌會輸出到控制台，包括：
- WebSocket 連接/斷開
- 消息發送記錄
- API 請求記錄

### 查看前端日誌
打開瀏覽器開發者工具（F12），查看：
- Console：JavaScript 錯誤和日誌
- Network：API 請求和 WebSocket 連接
- Application：LocalStorage 和 SessionStorage

### 數據庫查詢
```python
# 在 Python 中查詢消息
from shared.database.connection import get_db
from shared.database.models import Message, User

with get_db() as db:
    # 查詢所有消息
    messages = db.query(Message).all()
    for msg in messages:
        print(f"消息 ID: {msg.id}, 用戶 ID: {msg.user_id}, 內容: {msg.content}")
    
    # 查詢用戶
    users = db.query(User).all()
    for user in users:
        print(f"用戶 ID: {user.id}, TG ID: {user.tg_id}")
```

## 六、下一步

測試完成後，可以：
1. 部署到服務器
2. 添加更多消息類型
3. 實現通知設置 UI
4. 優化性能和用戶體驗

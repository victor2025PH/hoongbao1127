# ğŸš€ å…¨çƒç¤¾äº¤é‡‘èå¹³å° - å¯¦æ–½è¨ˆåŠƒ

**æ–‡ä»¶è·¯å¾‘ï¼š** `c:\hbgm001\docs\architecture\å¯¦æ–½è¨ˆåŠƒ.md`

---

## åŸ·è¡Œæ‘˜è¦

å°‡ç¾æœ‰çš„ Telegram ç´…åŒ…éŠæˆ²è½‰å‹ç‚º **å…¨çƒç¤¾äº¤é‡‘èå¹³å°**ï¼Œå…·å‚™ä»¥ä¸‹åŠŸèƒ½ï¼š
- é€šç”¨å­˜å–ï¼ˆTelegram + Web/H5/PWAï¼‰
- é›¶æ‰‹çºŒè²»å…§éƒ¨è½‰å¸³ï¼ˆéˆä¸‹å¸³æœ¬ï¼‰
- æ³•å¹£è½‰åŠ å¯†è²¨å¹£é–˜é“ï¼ˆéŠ€è¯ã€æ”¯ä»˜å¯¶ï¼‰
- è·¨å¹³å°ç—…æ¯’å¼åˆ†äº«

---

## ğŸ“‹ éšæ®µæ¦‚è¦½

| éšæ®µ | æ™‚é•· | é‡é» | äº¤ä»˜æˆæœ |
|------|------|------|----------|
| **ç¬¬ä¸€éšæ®µ** | 2 é€± | åŸºç¤æ¶æ§‹ | è³‡æ–™åº«é·ç§»ã€èªè­‰å±¤ |
| **ç¬¬äºŒéšæ®µ** | 2 é€± | å¸³æœ¬ç³»çµ± | è¤‡å¼è¨˜å¸³ã€Redis |
| **ç¬¬ä¸‰éšæ®µ** | 2 é€± | æ³•å¹£é–˜é“ | æ”¯ä»˜æ•´åˆ |
| **ç¬¬å››éšæ®µ** | 2 é€± | é€šç”¨å­˜å– | H5/PWAã€æ·±åº¦é€£çµ |
| **ç¬¬äº”éšæ®µ** | 1 é€± | ç—…æ¯’åŠŸèƒ½ | æ¨è–¦ç³»çµ±ã€ç¤¾äº¤åˆ†äº« |
| **ç¬¬å…­éšæ®µ** | 1 é€± | æ¸¬è©¦èˆ‡ä¸Šç·š | QAã€æ•ˆèƒ½æ¸¬è©¦ |

**ç¸½è¨ˆï¼š10 é€±**

---

## ğŸ“ ç¬¬ä¸€éšæ®µï¼šåŸºç¤æ¶æ§‹ï¼ˆç¬¬ 1-2 é€±ï¼‰

### 1.1 è³‡æ–™åº«æ¶æ§‹é·ç§»

```bash
# æ­¥é©Ÿ 1ï¼šå‰µå»ºé·ç§»æ–‡ä»¶
alembic revision --autogenerate -m "v2_universal_identity"
alembic revision --autogenerate -m "v2_ledger_system"
alembic revision --autogenerate -m "v2_fiat_payments"
alembic revision --autogenerate -m "v2_referral_system"

# æ­¥é©Ÿ 2ï¼šåŸ·è¡Œé·ç§»ï¼ˆå…ˆå‚™ä»½ï¼‰
pg_dump -h localhost -U postgres luckyred > backup_before_v2.sql
alembic upgrade head
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å‰µå»ºæ–°æ¶æ§‹æ–‡ä»¶ï¼ˆ`è³‡æ–™åº«æ¨¡å‹_v2.py`ï¼‰ âœ… å·²å®Œæˆ
- [ ] ç”Ÿæˆ Alembic é·ç§»è…³æœ¬
- [ ] ç‚ºç¾æœ‰ `users` è¡¨æ·»åŠ æ–°æ¬„ä½ï¼š
  - `uuid` (UUID)
  - `email`, `email_verified`
  - `phone`, `phone_verified`
  - `wallet_address`, `wallet_chain`
  - `identity_status`, `kyc_level`
- [ ] å‰µå»ºæ–°è¡¨ï¼š
  - `user_auth_providers` - ç”¨æˆ¶èªè­‰æä¾›è€…
  - `user_balances` - ç”¨æˆ¶é¤˜é¡
  - `ledger_entries` - å¸³æœ¬æ¢ç›®
  - `fiat_payments` - æ³•å¹£æ”¯ä»˜
  - `exchange_rates` - åŒ¯ç‡
  - `referral_links` - æ¨è–¦é€£çµ
  - `referral_events` - æ¨è–¦äº‹ä»¶
  - `user_sessions` - ç”¨æˆ¶æœƒè©±
- [ ] å°‡ç¾æœ‰é¤˜é¡æ•¸æ“šé·ç§»åˆ° `user_balances` è¡¨
- [ ] å‰µå»ºæ•ˆèƒ½ç´¢å¼•

### 1.2 èªè­‰å±¤é‡æ§‹

#### æ–‡ä»¶ï¼š`api/utils/auth_v2.py`

```python
# æ–°çš„çµ±ä¸€èªè­‰æ¨¡çµ„çµæ§‹
api/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ auth_v2.py              # çµ±ä¸€èªè­‰å±¤
â”‚   â”œâ”€â”€ telegram_auth.py        # Telegram å°ˆç”¨èªè­‰
â”‚   â”œâ”€â”€ social_auth.py          # ç¤¾äº¤ç™»å…¥ (Particle/Web3Auth)
â”‚   â””â”€â”€ wallet_auth.py          # Web3 éŒ¢åŒ…èªè­‰
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å‰µå»º `AuthProvider` åˆ—èˆ‰
- [ ] å¯¦ä½œ `TelegramAuthHandler`ï¼š
  ```python
  async def verify_telegram_init_data(init_data: str) -> Optional[TelegramUser]
  ```
- [ ] å¯¦ä½œ `SocialAuthHandler`ï¼š
  ```python
  async def verify_particle_token(token: str) -> Optional[SocialUser]
  async def verify_web3auth_token(token: str) -> Optional[SocialUser]
  ```
- [ ] å¯¦ä½œ `WalletAuthHandler`ï¼š
  ```python
  async def verify_wallet_signature(address: str, message: str, signature: str) -> bool
  ```
- [ ] å‰µå»ºçµ±ä¸€çš„ `get_current_user` ä¾è³´ï¼š
  ```python
  async def get_current_user(
      authorization: str = Header(None),
  ) -> User:
      # å¾æ¨™é ­è‡ªå‹•åµæ¸¬èªè­‰æ–¹æ³•
      if authorization.startswith("tma "):
          return await telegram_auth(authorization[4:])
      elif authorization.startswith("Bearer "):
          return await jwt_auth(authorization[7:])
      raise HTTPException(401, "ç„¡æ•ˆçš„èªè­‰")
  ```

### 1.3 API è·¯ç”±é‡çµ„

```
api/routers/
â”œâ”€â”€ v1/                    # èˆŠç‰ˆè·¯ç”±ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
â””â”€â”€ v2/                    # æ–°ç‰ˆçµ±ä¸€è·¯ç”±
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ auth.py           # æ‰€æœ‰èªè­‰ç«¯é»
    â”œâ”€â”€ users.py          # ç”¨æˆ¶ç®¡ç†
    â”œâ”€â”€ wallet.py         # é¤˜é¡èˆ‡è½‰å¸³
    â”œâ”€â”€ packets.py        # ç´…åŒ…
    â”œâ”€â”€ referral.py       # æ¨è–¦ç³»çµ±
    â””â”€â”€ game.py           # éŠæˆ²èˆ‡æ´»å‹•
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å‰µå»º v2 è·¯ç”±çµæ§‹
- [ ] ä¿æŒ v1 è·¯ç”±æ­£å¸¸é‹ä½œï¼ˆå‘å¾Œå…¼å®¹ï¼‰
- [ ] æ·»åŠ  API ç‰ˆæœ¬æ§åˆ¶ä¸­é–“ä»¶
- [ ] æ›´æ–° OpenAPI æ–‡æª”

---

## ğŸ“ ç¬¬äºŒéšæ®µï¼šå¸³æœ¬ç³»çµ±ï¼ˆç¬¬ 3-4 é€±ï¼‰

### 2.1 è¤‡å¼è¨˜å¸³æœå‹™

#### æ–‡ä»¶ï¼š`api/services/ledger_service.py`

```python
class LedgerService:
    """
    å…·æœ‰ ACID ä¿è­‰çš„æ ¸å¿ƒå¸³æœ¬æ“ä½œ
    """
    
    async def transfer(
        self,
        from_user_id: int,
        to_user_id: int,
        currency: CurrencyType,
        amount: Decimal,
        category: LedgerCategory,
        ref_type: str = None,
        ref_id: str = None,
    ) -> UUID:
        """
        åŸ·è¡Œå…©å€‹ç”¨æˆ¶ä¹‹é–“çš„è½‰å¸³ã€‚
        åŸå­æ€§åœ°å‰µå»ºå…©æ¢å¸³æœ¬è¨˜éŒ„ï¼ˆè²¸æ–¹ + å€Ÿæ–¹ï¼‰ã€‚
        """
        pass
    
    async def credit(
        self,
        user_id: int,
        currency: CurrencyType,
        amount: Decimal,
        category: LedgerCategory,
        ...
    ) -> UUID:
        """å¢åŠ ç”¨æˆ¶é¤˜é¡"""
        pass
    
    async def debit(
        self,
        user_id: int,
        currency: CurrencyType,
        amount: Decimal,
        category: LedgerCategory,
        ...
    ) -> UUID:
        """æ¸›å°‘ç”¨æˆ¶é¤˜é¡"""
        pass
    
    async def get_balance(
        self,
        user_id: int,
        currency: CurrencyType,
    ) -> Decimal:
        """ç²å–ç•¶å‰é¤˜é¡ï¼ˆå¾å¿«å–çš„ UserBalance è¡¨ï¼‰"""
        pass
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å¯¦ä½œ `LedgerService` é¡
- [ ] æ·»åŠ è³‡æ–™åº«è§¸ç™¼å™¨ï¼Œåœ¨å¸³æœ¬æ’å…¥æ™‚æ›´æ–° `user_balances`
- [ ] åœ¨æ¯æ¢å¸³æœ¬è¨˜éŒ„ä¸­å¯¦ä½œé¤˜é¡å¿«ç…§
- [ ] æ·»åŠ å¯©è¨ˆè¿½è¹¤æŸ¥è©¢
- [ ] å‰µå»ºå¸³æœ¬å°å¸³ä½œæ¥­

### 2.2 Redis é«˜ä¸¦ç™¼å±¤

#### æ–‡ä»¶ï¼š`api/services/redis_packet_service.py`

```python
class RedisPacketService:
    """
    ä½¿ç”¨ Redis + Lua çš„é«˜ä¸¦ç™¼ç´…åŒ…é ˜å–
    """
    
    CLAIM_SCRIPT = """..."""  # ä¾†è‡ª Redisé«˜ä¸¦ç™¼è…³æœ¬.lua çš„ Lua è…³æœ¬
    
    async def init_packet(self, packet_id: str, total_count: int, total_amount: Decimal):
        """å‰µå»ºç´…åŒ…æ™‚åœ¨ Redis ä¸­åˆå§‹åŒ–"""
        pass
    
    async def claim_packet(self, packet_id: str, user_id: int) -> ClaimResult:
        """
        Redis ä¸­çš„åŸå­é ˜å–æ“ä½œã€‚
        ç«‹å³è¿”å›çµæœã€‚
        å¯¦éš› DB å¯«å…¥ç•°æ­¥é€²è¡Œã€‚
        """
        pass
    
    async def sync_to_db(self, packet_id: str):
        """
        å°‡ Redis é ˜å–è¨˜éŒ„åŒæ­¥åˆ° PostgreSQL çš„å¾Œå°ä½œæ¥­ã€‚
        ç”± worker é€²ç¨‹åŸ·è¡Œã€‚
        """
        pass
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] è¨­ç½® Redis é€£æ¥æ± 
- [ ] è¨»å†Š Lua è…³æœ¬
- [ ] å¯¦ä½œ `RedisPacketService`
- [ ] å‰µå»º BullMQ worker ç”¨æ–¼ç•°æ­¥ DB åŒæ­¥ï¼š
  ```python
  # worker.py
  async def process_claim_queue():
      while True:
          claim = await redis.blpop("claims_queue")
          await sync_claim_to_postgres(claim)
  ```
- [ ] æ·»åŠ  Redis Sentinel/Cluster ä»¥å¯¦ç¾é«˜å¯ç”¨
- [ ] å¯¦ä½œ Redis å¤±æ•—æ™‚çš„é™ç´šç­–ç•¥

### 2.3 é¤˜é¡å¿«å–å±¤

```python
class BalanceCache:
    """
    å¸¶æœ‰å¯«ç©¿çš„ Redis ç”¨æˆ¶é¤˜é¡å¿«å–
    """
    
    async def get_balance(self, user_id: int, currency: str) -> Decimal:
        # å…ˆå˜—è©¦ Redis
        cached = await redis.get(f"balance:{user_id}:{currency}")
        if cached:
            return Decimal(cached)
        
        # é™ç´šåˆ° DB
        balance = await db_get_balance(user_id, currency)
        await redis.setex(f"balance:{user_id}:{currency}", 300, str(balance))
        return balance
    
    async def invalidate(self, user_id: int, currency: str = None):
        if currency:
            await redis.delete(f"balance:{user_id}:{currency}")
        else:
            # ä½¿æ‰€æœ‰å¹£ç¨®å¤±æ•ˆ
            for c in CurrencyType:
                await redis.delete(f"balance:{user_id}:{c.value}")
```

---

## ğŸ“ ç¬¬ä¸‰éšæ®µï¼šæ³•å¹£é–˜é“ï¼ˆç¬¬ 5-6 é€±ï¼‰

### 3.1 æ”¯ä»˜æä¾›è€…æŠ½è±¡

#### æ–‡ä»¶ï¼š`api/services/payment/base.py`

```python
from abc import ABC, abstractmethod

class PaymentProvider(ABC):
    """æ”¯ä»˜æä¾›è€…åŸºé¡"""
    
    @abstractmethod
    async def create_order(
        self,
        amount: Decimal,
        currency: str,
        user_id: int,
        return_url: str,
    ) -> PaymentOrder:
        """å‰µå»ºæ”¯ä»˜è¨‚å–®"""
        pass
    
    @abstractmethod
    async def verify_webhook(
        self,
        payload: dict,
        signature: str,
    ) -> PaymentResult:
        """é©—è­‰å›èª¿ç°½å"""
        pass
    
    @abstractmethod
    async def query_order(self, order_id: str) -> PaymentStatus:
        """æŸ¥è©¢è¨‚å–®ç‹€æ…‹"""
        pass
```

### 3.2 æä¾›è€…å¯¦ä½œ

```
api/services/payment/
â”œâ”€â”€ base.py             # åŸºé¡
â”œâ”€â”€ alchemy_pay.py      # Alchemy Pay æ•´åˆ
â”œâ”€â”€ unlimit.py          # Unlimit æ•´åˆ
â””â”€â”€ mock.py             # æ¸¬è©¦ç”¨æ¨¡æ“¬æä¾›è€…
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å¯¦ä½œ `AlchemyPayProvider`ï¼š
  - [ ] API é‡‘é‘°ç®¡ç†
  - [ ] è¨‚å–®å‰µå»º
  - [ ] Webhook ç°½åé©—è­‰
  - [ ] ç‹€æ…‹è¼ªè©¢
- [ ] å¯¦ä½œ `UnlimitProvider`
- [ ] å‰µå»º webhook ç«¯é»ï¼š
  ```python
  @router.post("/wallet/deposit/fiat/webhook/{provider}")
  async def payment_webhook(provider: str, request: Request):
      # 1. é©—è­‰ç°½å
      # 2. æ›´æ–° FiatPayment ç‹€æ…‹
      # 3. é€šé LedgerService å¢åŠ ç”¨æˆ¶é¤˜é¡
      # 4. ç™¼é€é€šçŸ¥
  ```

### 3.3 è‡ªå‹•è½‰æ›æœå‹™

#### æ–‡ä»¶ï¼š`api/services/exchange_service.py`

```python
class ExchangeService:
    """
    è™•ç†æ³•å¹£è½‰åŠ å¯†è²¨å¹£è½‰æ›
    """
    
    async def get_rate(self, from_currency: str, to_currency: str) -> Decimal:
        """ç²å–ç•¶å‰åŒ¯ç‡"""
        # å…ˆå˜—è©¦å¿«å–
        rate = await redis.get(f"rate:{from_currency}:{to_currency}")
        if rate:
            return Decimal(rate)
        
        # å¾é è¨€æ©Ÿç²å–ï¼ˆBinanceã€CoinGecko ç­‰ï¼‰
        rate = await self._fetch_rate(from_currency, to_currency)
        await redis.setex(f"rate:{from_currency}:{to_currency}", 60, str(rate))
        return rate
    
    async def convert_fiat_to_crypto(
        self,
        user_id: int,
        fiat_amount: Decimal,
        fiat_currency: str,
        target_crypto: CurrencyType,
    ) -> Decimal:
        """
        å°‡æ³•å¹£æ”¯ä»˜è½‰æ›ç‚ºåŠ å¯†è²¨å¹£è²¸è¨˜ã€‚
        åœ¨æ³•å¹£æ”¯ä»˜ç¢ºèªå¾Œèª¿ç”¨ã€‚
        """
        rate = await self.get_rate(fiat_currency, target_crypto.value)
        crypto_amount = fiat_amount / rate
        
        # é€šéå¸³æœ¬è²¸è¨˜
        await ledger_service.credit(
            user_id=user_id,
            currency=target_crypto,
            amount=crypto_amount,
            category=LedgerCategory.FIAT_DEPOSIT,
        )
        
        return crypto_amount
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å¯¦ä½œ `ExchangeService`
- [ ] è¨­ç½®åŒ¯ç‡é è¨€æ©Ÿï¼ˆBinance API / CoinGeckoï¼‰
- [ ] å‰µå»ºåŒ¯ç‡æ›´æ–°å®šæ™‚ä»»å‹™ï¼ˆæ¯ 1 åˆ†é˜ï¼‰
- [ ] è™•ç†åŒ¯ç‡æ»‘é»ä¿è­·
- [ ] æ·»åŠ ç®¡ç†å“¡æ‰‹å‹•è¦†è“‹åŒ¯ç‡åŠŸèƒ½

---

## ğŸ“ ç¬¬å››éšæ®µï¼šé€šç”¨å­˜å–ï¼ˆç¬¬ 7-8 é€±ï¼‰

### 4.1 å‰ç«¯ç’°å¢ƒåµæ¸¬

#### æ–‡ä»¶ï¼š`frontend/src/utils/environment.ts`

```typescript
export enum AppEnvironment {
  TELEGRAM_MINIAPP = 'telegram_miniapp',  // Telegram å°ç¨‹å¼
  WEB_BROWSER = 'web_browser',            // ç¶²é ç€è¦½å™¨
  PWA = 'pwa',                            // æ¼¸é€²å¼ç¶²é æ‡‰ç”¨
}

export function detectEnvironment(): AppEnvironment {
  // æª¢æŸ¥æ˜¯å¦åœ¨ Telegram å…§é‹è¡Œ
  if (window.Telegram?.WebApp?.initData) {
    return AppEnvironment.TELEGRAM_MINIAPP;
  }
  
  // æª¢æŸ¥æ˜¯å¦æ˜¯ PWA
  if (window.matchMedia('(display-mode: standalone)').matches) {
    return AppEnvironment.PWA;
  }
  
  return AppEnvironment.WEB_BROWSER;
}

export function getAuthStrategy(): 'telegram' | 'social' | 'wallet' {
  const env = detectEnvironment();
  
  if (env === AppEnvironment.TELEGRAM_MINIAPP) {
    return 'telegram';
  }
  
  // å°æ–¼ webï¼Œæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²é€£æ¥éŒ¢åŒ…
  if (localStorage.getItem('wallet_connected')) {
    return 'wallet';
  }
  
  return 'social';
}
```

### 4.2 é›™æ¨¡å¼èªè­‰æä¾›è€…

#### æ–‡ä»¶ï¼š`frontend/src/providers/AuthProvider.tsx`

```tsx
import { ParticleNetwork } from '@particle-network/auth';
import { Web3Auth } from '@web3auth/modal';

export const AuthProvider: React.FC = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [authMethod, setAuthMethod] = useState<'telegram' | 'social' | 'wallet' | null>(null);
  
  useEffect(() => {
    const init = async () => {
      const env = detectEnvironment();
      
      if (env === AppEnvironment.TELEGRAM_MINIAPP) {
        // ä½¿ç”¨ Telegram éœé»˜èªè­‰
        const initData = window.Telegram.WebApp.initData;
        const result = await api.post('/auth/telegram', { initData });
        setUser(result.user);
        setAuthMethod('telegram');
      } else {
        // æª¢æŸ¥ç¾æœ‰æœƒè©±
        const session = await checkExistingSession();
        if (session) {
          setUser(session.user);
          setAuthMethod(session.method);
        }
      }
    };
    
    init();
  }, []);
  
  const loginWithSocial = async (provider: 'google' | 'apple' | 'email') => {
    // ä½¿ç”¨ Particle Network
    const particle = new ParticleNetwork({ ... });
    const userInfo = await particle.auth.login({ provider });
    
    const result = await api.post('/auth/social', {
      provider: 'particle',
      token: userInfo.token,
    });
    
    setUser(result.user);
    setAuthMethod('social');
  };
  
  const loginWithWallet = async () => {
    // ä½¿ç”¨ Web3Auth æˆ–ç›´æ¥éŒ¢åŒ…
    const web3auth = new Web3Auth({ ... });
    await web3auth.connect();
    
    // ç°½åè¨Šæ¯é€²è¡Œèªè­‰
    const message = await api.get('/auth/wallet/challenge');
    const signature = await web3auth.signMessage(message);
    
    const result = await api.post('/auth/wallet', {
      address: web3auth.address,
      message,
      signature,
    });
    
    setUser(result.user);
    setAuthMethod('wallet');
  };
  
  return (
    <AuthContext.Provider value={{ user, authMethod, loginWithSocial, loginWithWallet }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### 4.3 æ™ºæ…§æ·±åº¦é€£çµ

#### æ–‡ä»¶ï¼š`api/routers/v2/redirect.py`

```python
@router.get("/r/{code}")
async def smart_redirect(code: str, request: Request):
    """
    é€šç”¨é‡å®šå‘ç«¯é»ã€‚
    åµæ¸¬å®¢æˆ¶ç«¯ä¸¦é©ç•¶é‡å®šå‘ã€‚
    """
    user_agent = request.headers.get("user-agent", "").lower()
    
    # è§£æä»£ç¢¼ä»¥ç¢ºå®šé¡å‹
    link = await get_link_by_code(code)
    
    if not link:
        raise HTTPException(404, "é€£çµä¸å­˜åœ¨")
    
    # åµæ¸¬æ˜¯å¦ç‚º Telegram æ‡‰ç”¨
    is_telegram = "telegram" in user_agent or "tg" in request.query_params
    
    if is_telegram:
        # é‡å®šå‘åˆ° Telegram Mini App
        return RedirectResponse(
            f"https://t.me/{BOT_USERNAME}/app?startapp={code}"
        )
    else:
        # é‡å®šå‘åˆ° H5 ç¶²é ç‰ˆ
        return RedirectResponse(
            f"https://app.yoursite.com/?ref={code}"
        )
```

### 4.4 PWA é…ç½®

#### æ–‡ä»¶ï¼š`frontend/public/manifest.json`

```json
{
  "name": "Lucky Red - ç¤¾äº¤é‡‘èå¹³å°",
  "short_name": "Lucky Red",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a1a2e",
  "theme_color": "#e94560",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å¯¦ä½œç’°å¢ƒåµæ¸¬
- [ ] è¨­ç½® Particle Network SDK
- [ ] è¨­ç½® Web3Auth SDKï¼ˆå¯é¸ï¼‰
- [ ] å‰µå»º web ç™»å…¥/è¨»å†Š UI
- [ ] å¯¦ä½œæ™ºæ…§æ·±åº¦é€£çµ
- [ ] é…ç½® PWA manifest
- [ ] æ·»åŠ  service worker æ”¯æ´é›¢ç·š
- [ ] åœ¨ iOS Safariã€Android Chrome ä¸Šæ¸¬è©¦

---

## ğŸ“ ç¬¬äº”éšæ®µï¼šç—…æ¯’åŠŸèƒ½ï¼ˆç¬¬ 9 é€±ï¼‰

### 5.1 æ¨è–¦ç³»çµ±

#### æ–‡ä»¶ï¼š`api/services/referral_service.py`

```python
class ReferralService:
    """ç®¡ç†æ¨è–¦é€£çµå’Œçå‹µ"""
    
    async def create_link(
        self,
        user_id: int,
        platform: str = None,
        campaign: str = None,
    ) -> ReferralLink:
        """å‰µå»ºæ–°çš„æ¨è–¦é€£çµ"""
        code = generate_unique_code()
        link = ReferralLink(
            user_id=user_id,
            code=code,
            platform=platform,
            campaign=campaign,
        )
        await db.save(link)
        return link
    
    async def track_event(
        self,
        code: str,
        event_type: str,  # click, signup, first_deposit
        referred_user_id: int = None,
        metadata: dict = None,
    ):
        """è¿½è¹¤æ¨è–¦äº‹ä»¶"""
        pass
    
    async def calculate_reward(
        self,
        referrer_id: int,
        referred_id: int,
        event_type: str,
    ) -> Decimal:
        """è¨ˆç®—ä¸¦ç™¼æ”¾æ¨è–¦çå‹µ"""
        # ç²å–çå‹µé…ç½®
        config = await get_referral_config()
        
        if event_type == 'signup':
            reward = config.signup_reward  # ä¾‹å¦‚ï¼š1 USDT
        elif event_type == 'first_deposit':
            # é¦–æ¬¡å……å€¼çš„ç™¾åˆ†æ¯”
            deposit = await get_first_deposit(referred_id)
            reward = deposit * config.deposit_commission  # ä¾‹å¦‚ï¼š5%
        
        # è²¸è¨˜çµ¦æ¨è–¦äºº
        await ledger_service.credit(
            user_id=referrer_id,
            currency=CurrencyType.USDT,
            amount=reward,
            category=LedgerCategory.REFERRAL_BONUS,
        )
        
        return reward
```

### 5.2 ç¤¾äº¤åˆ†äº«å¡ç‰‡

#### æ–‡ä»¶ï¼š`api/services/share_service.py`

```python
class ShareService:
    """ç‚ºä¸åŒå¹³å°ç”Ÿæˆåˆ†äº«å…§å®¹"""
    
    async def generate_packet_share(self, packet_id: str) -> ShareContent:
        """ç‚ºç´…åŒ…ç”Ÿæˆåˆ†äº«å…§å®¹"""
        packet = await get_packet(packet_id)
        
        # ç”Ÿæˆ OG åœ–ç‰‡
        og_image = await self._generate_og_image(packet)
        
        return ShareContent(
            url=f"https://app.yoursite.com/r/p_{packet_id}",
            title=f"ğŸ§§ {packet.message}",
            description=f"æœ‰äººç™¼é€äº† {packet.total_amount} {packet.currency.upper()} ç´…åŒ…çµ¦æ‚¨ï¼",
            image=og_image,
            # å¹³å°ç‰¹å®š
            twitter_text=f"ğŸ§§ æˆ‘å‰›æ”¶åˆ°ä¸€å€‹ç´…åŒ…ï¼å¿«ä¾†æ¶ï¼š",
            whatsapp_text=f"ğŸ§§ {packet.message}\n\né»æ“Šé ˜å–ï¼š",
        )
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å¯¦ä½œ `ReferralService`
- [ ] å‰µå»ºæ¨è–¦é€£çµç”Ÿæˆç«¯é»
- [ ] å¯¦ä½œé»æ“Šè¿½è¹¤ï¼ˆå¸¶é€Ÿç‡é™åˆ¶ï¼‰
- [ ] è¨­ç½®çå‹µè¨ˆç®—å’Œç™¼æ”¾
- [ ] å‰µå»ºæ¨è–¦æ’è¡Œæ¦œ
- [ ] ç‚ºç¤¾äº¤åˆ†äº«ç”Ÿæˆ OG åœ–ç‰‡
- [ ] åœ¨ UI ä¸­æ·»åŠ åˆ†äº«æŒ‰éˆ•

---

## ğŸ“ ç¬¬å…­éšæ®µï¼šæ¸¬è©¦èˆ‡ä¸Šç·šï¼ˆç¬¬ 10 é€±ï¼‰

### 6.1 æ¸¬è©¦æ¸…å–®

#### å–®å…ƒæ¸¬è©¦
- [ ] èªè­‰è™•ç†å™¨ï¼ˆæ‰€æœ‰æä¾›è€…ï¼‰
- [ ] å¸³æœ¬æœå‹™ï¼ˆè¤‡å¼è¨˜å¸³å®Œæ•´æ€§ï¼‰
- [ ] Redis Lua è…³æœ¬
- [ ] æ”¯ä»˜ webhook é©—è­‰
- [ ] åŒ¯ç‡æœå‹™

#### æ•´åˆæ¸¬è©¦
- [ ] å®Œæ•´æ”¯ä»˜æµç¨‹ï¼ˆå‰µå»º â†’ webhook â†’ è²¸è¨˜ï¼‰
- [ ] ç´…åŒ…æµç¨‹ï¼ˆå‰µå»º â†’ é ˜å– â†’ DB åŒæ­¥ï¼‰
- [ ] è·¨å¹³å°èªè­‰ï¼ˆTelegram â†’ é€£çµéŒ¢åŒ…ï¼‰
- [ ] æ¨è–¦æµç¨‹ï¼ˆå‰µå»ºé€£çµ â†’ è¨»å†Š â†’ çå‹µï¼‰

#### è² è¼‰æ¸¬è©¦
```bash
# å¤§è¦æ¨¡æ¸¬è©¦ç´…åŒ…é ˜å–
wrk -t12 -c400 -d30s -s claim_packet.lua http://localhost:8080/api/v2/packets/{id}/claim

# ç›®æ¨™ï¼š10,000 QPSï¼Œp99 < 100ms
```

### 6.2 ç›£æ§èˆ‡å‘Šè­¦

```yaml
# Prometheus å‘Šè­¦
- alert: Redisç´…åŒ…éšŠåˆ—ç©å£“
  expr: redis_list_length{key="claims_queue"} > 1000
  for: 5m
  labels:
    severity: warning

- alert: å¸³æœ¬é¤˜é¡ä¸åŒ¹é…
  expr: ledger_balance_check_failures > 0
  labels:
    severity: critical
```

### 6.3 ä¸Šç·šæ¸…å–®

- [ ] è³‡æ–™åº«é·ç§»å·²å¥—ç”¨
- [ ] Redis Sentinel å·²é…ç½®
- [ ] æ”¯ä»˜æä¾›è€… webhook å·²é©—è­‰
- [ ] SSL æ†‘è­‰æœ‰æ•ˆ
- [ ] é€Ÿç‡é™åˆ¶å·²é…ç½®
- [ ] ç›£æ§å„€è¡¨æ¿å°±ç·’
- [ ] å›æ»¾è¨ˆåŠƒå·²æ–‡æª”åŒ–
- [ ] å€¼ç­è¼ªæ›å·²å®‰æ’

---

## ğŸ“Š æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ¶ç«¯                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Telegram Mini   â”‚   â”‚  H5 Web / PWA   â”‚   â”‚  åŸç”Ÿ Apps      â”‚           â”‚
â”‚  â”‚     App         â”‚   â”‚   (å¤–éƒ¨ç”¨æˆ¶)     â”‚   â”‚   (æœªä¾†)        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API é–˜é“ (Nginx)                                  â”‚
â”‚                     é€Ÿç‡é™åˆ¶ã€SSLã€è² è¼‰å‡è¡¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             èªè­‰å±¤                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Telegram   â”‚  â”‚  Particle   â”‚  â”‚  Web3Auth   â”‚  â”‚   éŒ¢åŒ…      â”‚        â”‚
â”‚  â”‚  initData   â”‚  â”‚   Network   â”‚  â”‚    JWT      â”‚  â”‚   ç°½å      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                  â”‚   çµ±ä¸€æœƒè©±       â”‚                                        â”‚
â”‚                  â”‚      JWT        â”‚                                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             æ‡‰ç”¨å±¤                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   éŒ¢åŒ…      â”‚  â”‚   ç´…åŒ…      â”‚  â”‚   æ¨è–¦      â”‚  â”‚    éŠæˆ²     â”‚        â”‚
â”‚  â”‚   æœå‹™      â”‚  â”‚   æœå‹™      â”‚  â”‚   æœå‹™      â”‚  â”‚    æœå‹™     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                â”‚                â”‚                â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                          â”‚                â”‚                                 â”‚
â”‚                          â–¼                â–¼                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                  â”‚         å¸³æœ¬æœå‹™             â”‚                            â”‚
â”‚                  â”‚      ï¼ˆè¤‡å¼è¨˜å¸³ï¼‰            â”‚                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL      â”‚ â”‚   Redis å¢é›†      â”‚ â”‚   è¨Šæ¯ä½‡åˆ—        â”‚
â”‚   (ä¸»è³‡æ–™åº«)       â”‚ â”‚   (å¿«å– + é–)     â”‚ â”‚   (BullMQ)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç”¨æˆ¶            â”‚ â”‚ â€¢ é¤˜é¡å¿«å–        â”‚ â”‚ â€¢ é ˜å–ä½‡åˆ—        â”‚
â”‚ â€¢ å¸³æœ¬æ¢ç›®        â”‚ â”‚ â€¢ ç´…åŒ…ç‹€æ…‹        â”‚ â”‚ â€¢ Webhook ä½‡åˆ—    â”‚
â”‚ â€¢ ç´…åŒ…            â”‚ â”‚ â€¢ é€Ÿç‡é™åˆ¶        â”‚ â”‚ â€¢ é€šçŸ¥ä½‡åˆ—        â”‚
â”‚ â€¢ æ”¯ä»˜            â”‚ â”‚ â€¢ æœƒè©±            â”‚ â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœå‹™                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Alchemy Pay â”‚  â”‚   Binance   â”‚  â”‚  Telegram   â”‚            â”‚
â”‚  â”‚   (æ³•å¹£)    â”‚  â”‚ (åŒ¯ç‡ API)  â”‚  â”‚   Bot API   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æœ€çµ‚ç›®éŒ„çµæ§‹

```
c:\hbgm001\
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ v1/                    # èˆŠç‰ˆè·¯ç”±ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
â”‚   â”‚   â””â”€â”€ v2/                    # æ–°ç‰ˆçµ±ä¸€è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ auth.py            # èªè­‰ç«¯é»
â”‚   â”‚       â”œâ”€â”€ users.py           # ç”¨æˆ¶ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ wallet.py          # é¤˜é¡èˆ‡è½‰å¸³
â”‚   â”‚       â”œâ”€â”€ packets.py         # ç´…åŒ…
â”‚   â”‚       â”œâ”€â”€ referral.py        # æ¨è–¦ç³»çµ±
â”‚   â”‚       â””â”€â”€ game.py            # éŠæˆ²èˆ‡æ´»å‹•
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ ledger_service.py      # è¤‡å¼è¨˜å¸³
â”‚   â”‚   â”œâ”€â”€ redis_packet_service.py # é«˜ä¸¦ç™¼é ˜å–
â”‚   â”‚   â”œâ”€â”€ exchange_service.py    # å¹£ç¨®è½‰æ›
â”‚   â”‚   â”œâ”€â”€ referral_service.py    # æ¨è–¦ç³»çµ±
â”‚   â”‚   â””â”€â”€ payment/
â”‚   â”‚       â”œâ”€â”€ base.py            # æ”¯ä»˜æä¾›è€…åŸºé¡
â”‚   â”‚       â”œâ”€â”€ alchemy_pay.py     # Alchemy Pay æ•´åˆ
â”‚   â”‚       â””â”€â”€ unlimit.py         # Unlimit æ•´åˆ
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ auth_v2.py             # çµ±ä¸€èªè­‰
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ workers/
â”‚       â”œâ”€â”€ claim_sync_worker.py   # Redis â†’ PostgreSQL åŒæ­¥
â”‚       â””â”€â”€ rate_update_worker.py  # åŒ¯ç‡æ›´æ–°
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”‚   â””â”€â”€ AuthProvider.tsx   # é›™æ¨¡å¼èªè­‰
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ environment.ts     # ç’°å¢ƒåµæ¸¬
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ public/
â”‚       â””â”€â”€ manifest.json          # PWA é…ç½®
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ models_v2.py           # æ–°æ¶æ§‹
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ architecture/              # æ¶æ§‹æ–‡æª”
â”‚       â”œâ”€â”€ è³‡æ–™åº«æ¨¡å‹_v2.py        # âœ… å·²å‰µå»º
â”‚       â”œâ”€â”€ APIè·¯ç”±çµæ§‹_v2.md       # âœ… å·²å‰µå»º
â”‚       â”œâ”€â”€ Redisé«˜ä¸¦ç™¼è…³æœ¬.lua     # âœ… å·²å‰µå»º
â”‚       â””â”€â”€ å¯¦æ–½è¨ˆåŠƒ.md            # âœ… å·²å‰µå»º
â””â”€â”€ migrations/
    â””â”€â”€ versions/
        â””â”€â”€ ...                    # Alembic é·ç§»
```

---

---

## ğŸ“ ç¬¬ä¸ƒéšæ®µï¼šå®‰å…¨èˆ‡åˆè¦å±¤ï¼ˆç¬¬ 11 é€±ï¼‰

### 7.1 å‹•æ…‹ UI æ¸²æŸ“ï¼ˆã€Œè®Šè‰²é¾ã€æ¨¡å¼ï¼‰

**ç›®æ¨™ï¼š** ç¬¦åˆ Apple/Google App Store æ”¿ç­–ï¼ŒåŒæ™‚ä¿æŒ Web/Android å®Œæ•´åŠŸèƒ½ã€‚

#### æ–‡ä»¶ï¼š`frontend/src/utils/platformRules.ts`

```typescript
export type PlatformType = 'ios' | 'android' | 'web' | 'telegram_miniapp';

export interface PlatformRules {
  platform: PlatformType;
  features: {
    showDepositFiat: boolean;
    showWithdrawUSDT: boolean;
    showExchange: boolean;
    showStarsPurchase: boolean;
    showFullDashboard: boolean;
  };
  compliance: {
    showWebPortalBanner: boolean;
    bannerMessage: string;
    webPortalUrl: string;
  };
}

export function detectPlatform(): PlatformType {
  // æª¢æŸ¥æ˜¯å¦åœ¨ Telegram Mini App å…§
  if (window.Telegram?.WebApp?.initData) {
    // Telegram å…§éƒ¨é€²ä¸€æ­¥å€åˆ† iOS/Android
    const platform = window.Telegram?.WebApp?.platform;
    if (platform === 'ios') return 'ios';
    if (platform === 'android') return 'android';
    return 'telegram_miniapp';
  }

  // æª¢æŸ¥ iOS è£ç½®ï¼ˆSafari æˆ– PWAï¼‰
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  if (isIOS) return 'ios';

  // æª¢æŸ¥ Android è£ç½®
  const isAndroid = /Android/.test(navigator.userAgent);
  if (isAndroid) return 'android';

  return 'web';
}

export function getPlatformRules(): PlatformRules {
  const platform = detectPlatform();

  // iOS é™åˆ¶æ¨¡å¼ï¼šéš±è—é‡‘èåŠŸèƒ½ä»¥ç¬¦åˆ App Store æ”¿ç­–
  if (platform === 'ios') {
    return {
      platform,
      features: {
        showDepositFiat: false,
        showWithdrawUSDT: false,
        showExchange: false,
        showStarsPurchase: true,  // åªå…è¨± Stars è³¼è²·
        showFullDashboard: false,
      },
      compliance: {
        showWebPortalBanner: true,
        bannerMessage: 'ç®¡ç†æ‚¨çš„è³‡ç”¢è«‹è¨ªå•æˆ‘å€‘çš„ç¶²é ç‰ˆ',
        webPortalUrl: 'https://app.yoursite.com/wallet',
      },
    };
  }

  // Android & Webï¼šå®Œæ•´åŠŸèƒ½
  return {
    platform,
    features: {
      showDepositFiat: true,
      showWithdrawUSDT: true,
      showExchange: true,
      showStarsPurchase: true,
      showFullDashboard: true,
    },
    compliance: {
      showWebPortalBanner: false,
      bannerMessage: '',
      webPortalUrl: '',
    },
  };
}

// React Hook
export function usePlatformRules(): PlatformRules {
  const [rules, setRules] = useState<PlatformRules>(() => getPlatformRules());

  useEffect(() => {
    // ç›£è½å¯èƒ½çš„å¹³å°è®ŠåŒ–ï¼ˆä¾‹å¦‚ï¼šPWA å®‰è£ï¼‰
    const handleResize = () => setRules(getPlatformRules());
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return rules;
}
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å‰µå»º `platformRules.ts` å·¥å…·
- [ ] å‰µå»º `usePlatformRules` React Hook
- [ ] æ›´æ–°éŒ¢åŒ…é é¢ä½¿ç”¨å¹³å°è¦å‰‡
- [ ] å‰µå»º `ComplianceBanner` çµ„ä»¶
- [ ] åœ¨ iOS ä¸Šéš±è—ã€Œå……å€¼æ³•å¹£ã€ã€ã€Œæç¾ USDTã€ã€ã€Œå…Œæ›ã€æŒ‰éˆ•
- [ ] æ·»åŠ å–®å…ƒæ¸¬è©¦

---

### 7.2 æµå‹•æ€§ç®¡ç†é‚è¼¯ï¼ˆStars å†·å»ç³»çµ±ï¼‰

**ç›®æ¨™ï¼š** é˜²æ­¢å›  Telegram 21 å¤© Stars æŒæœ‰æœŸé€ æˆçš„æµå‹•æ€§å±æ©Ÿã€‚

#### è³‡æ–™åº«æ›´æ–°ï¼š`shared/database/models.py`

```python
class CurrencySource(str, enum.Enum):
    """è³‡é‡‘ä¾†æºé¡å‹"""
    REAL_CRYPTO = "real_crypto"      # çœŸå¯¦åŠ å¯†è²¨å¹£å……å€¼
    STARS_CREDIT = "stars_credit"    # Telegram Stars å…Œæ›
    BONUS = "bonus"                  # çå‹µ/æ´»å‹•
    REFERRAL = "referral"            # æ¨è–¦çå‹µ

class WithdrawableStatus(str, enum.Enum):
    """å¯æç¾ç‹€æ…‹"""
    LOCKED = "locked"                # é–å®šä¸­
    COOLDOWN = "cooldown"            # å†·å»æœŸ
    WITHDRAWABLE = "withdrawable"    # å¯æç¾

# æ›´æ–° LedgerEntry è¡¨
class LedgerEntry(Base):
    """å¸³æœ¬æ¢ç›®"""
    __tablename__ = "ledger_entries"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    currency = Column(Enum(CurrencyType), nullable=False)
    amount = Column(Numeric(20, 8), nullable=False)
    
    # æ–°å¢ï¼šè³‡é‡‘ä¾†æºè¿½è¹¤
    currency_source = Column(Enum(CurrencySource), default=CurrencySource.REAL_CRYPTO)
    withdrawable_status = Column(Enum(WithdrawableStatus), default=WithdrawableStatus.WITHDRAWABLE)
    cooldown_until = Column(DateTime, nullable=True)  # å†·å»æœŸçµæŸæ™‚é–“
    
    # éŠæˆ²æµæ°´è¦æ±‚
    turnover_required = Column(Numeric(20, 8), default=0)  # éœ€è¦çš„æµæ°´
    turnover_completed = Column(Numeric(20, 8), default=0)  # å·²å®Œæˆæµæ°´
    
    # ... å…¶ä»–æ¬„ä½
```

#### æ–‡ä»¶ï¼š`api/services/liquidity_service.py`

```python
class LiquidityService:
    """æµå‹•æ€§ç®¡ç†æœå‹™"""
    
    # é…ç½®å¸¸é‡
    STARS_COOLDOWN_DAYS = 21  # Stars å†·å»æœŸï¼ˆå¤©ï¼‰
    TURNOVER_MULTIPLIER = 1.0  # æµæ°´å€æ•¸è¦æ±‚
    
    async def process_stars_deposit(
        self,
        user_id: int,
        stars_amount: int,
        usdt_equivalent: Decimal,
    ) -> LedgerEntry:
        """
        è™•ç† Stars å……å€¼ä¸¦è¨­å®šå†·å»æœŸ
        """
        cooldown_until = datetime.utcnow() + timedelta(days=self.STARS_COOLDOWN_DAYS)
        turnover_required = usdt_equivalent * self.TURNOVER_MULTIPLIER
        
        entry = await ledger_service.credit(
            user_id=user_id,
            currency=CurrencyType.USDT,
            amount=usdt_equivalent,
            category=LedgerCategory.STARS_CONVERSION,
            currency_source=CurrencySource.STARS_CREDIT,
            withdrawable_status=WithdrawableStatus.COOLDOWN,
            cooldown_until=cooldown_until,
            turnover_required=turnover_required,
        )
        
        return entry
    
    async def check_withdrawal_eligibility(
        self,
        user_id: int,
        amount: Decimal,
    ) -> WithdrawalCheck:
        """
        æª¢æŸ¥æç¾è³‡æ ¼
        """
        # ç²å–ç”¨æˆ¶å„ä¾†æºé¤˜é¡
        balances = await self._get_source_balances(user_id)
        
        withdrawable = balances.get(CurrencySource.REAL_CRYPTO, Decimal(0))
        
        # æª¢æŸ¥å·²è§£é–çš„ Stars é¤˜é¡
        unlocked_stars = await self._get_unlocked_stars_balance(user_id)
        withdrawable += unlocked_stars
        
        if amount > withdrawable:
            locked_amount = amount - withdrawable
            return WithdrawalCheck(
                eligible=False,
                withdrawable_amount=withdrawable,
                locked_amount=locked_amount,
                message=f"æœ‰ {locked_amount} USDT ä¾†è‡ª Stars ä»åœ¨å†·å»æœŸ"
            )
        
        return WithdrawalCheck(eligible=True, withdrawable_amount=amount)
    
    async def update_turnover(
        self,
        user_id: int,
        game_amount: Decimal,
    ):
        """
        æ›´æ–°éŠæˆ²æµæ°´ï¼Œè§£é–ç¬¦åˆæ¢ä»¶çš„è³‡é‡‘
        """
        # ç²å–æ‰€æœ‰éœ€è¦æµæ°´çš„å¸³æœ¬æ¢ç›®
        entries = await self._get_turnover_entries(user_id)
        
        remaining_turnover = game_amount
        for entry in entries:
            if remaining_turnover <= 0:
                break
            
            needed = entry.turnover_required - entry.turnover_completed
            applied = min(needed, remaining_turnover)
            
            entry.turnover_completed += applied
            remaining_turnover -= applied
            
            # æª¢æŸ¥æ˜¯å¦æ»¿è¶³è§£é–æ¢ä»¶
            if entry.turnover_completed >= entry.turnover_required:
                if entry.cooldown_until and entry.cooldown_until <= datetime.utcnow():
                    entry.withdrawable_status = WithdrawableStatus.WITHDRAWABLE
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] æ·»åŠ  `CurrencySource` åˆ—èˆ‰åˆ° models.py
- [ ] æ·»åŠ  `currency_source` æ¬„ä½åˆ°å¸³æœ¬
- [ ] å‰µå»º `LiquidityService` é¡
- [ ] å¯¦ä½œå†·å»æœŸæª¢æŸ¥é‚è¼¯
- [ ] å¯¦ä½œæµæ°´è¨ˆç®—é‚è¼¯
- [ ] æ›´æ–°æç¾ API åŠ å…¥è³‡æ ¼æª¢æŸ¥
- [ ] å‰µå»ºç®¡ç†å¾Œå°å†·å»æœŸæŸ¥çœ‹ä»‹é¢

---

### 7.3 å¸³æˆ¶é€£çµï¼ˆMagic Link èªè­‰ï¼‰

**ç›®æ¨™ï¼š** å…è¨± Telegram ç”¨æˆ¶ç„¡å¯†ç¢¼ç™»å…¥ H5/Web ç‰ˆæœ¬ã€‚

#### è³‡æ–™åº«æ›´æ–°

```python
class MagicLinkToken(Base):
    """Magic Link ä»¤ç‰Œè¡¨"""
    __tablename__ = "magic_link_tokens"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    token = Column(String(64), unique=True, nullable=False, index=True)
    
    # å®‰å…¨æ€§
    ip_address = Column(String(64), nullable=True)
    user_agent = Column(String(512), nullable=True)
    
    # ç‹€æ…‹
    is_used = Column(Boolean, default=False)
    used_at = Column(DateTime, nullable=True)
    expires_at = Column(DateTime, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    __table_args__ = (
        Index("ix_magic_link_token", "token"),
        Index("ix_magic_link_expires", "expires_at"),
    )
```

#### æ–‡ä»¶ï¼š`bot/handlers/web_login.py`

```python
from telegram import Update
from telegram.ext import ContextTypes

@router.message(Command("web_login"))
async def web_login_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    è™•ç† /web_login å‘½ä»¤
    ç”Ÿæˆä¸€æ¬¡æ€§ Magic Link ä¸¦ç™¼é€çµ¦ç”¨æˆ¶
    """
    user = update.effective_user
    
    # ç”Ÿæˆå®‰å…¨ä»¤ç‰Œ
    token = secrets.token_urlsafe(32)
    expires_at = datetime.utcnow() + timedelta(minutes=5)  # 5 åˆ†é˜æœ‰æ•ˆ
    
    # å­˜å„²ä»¤ç‰Œ
    magic_link = MagicLinkToken(
        user_id=user.id,
        token=token,
        expires_at=expires_at,
    )
    await db.save(magic_link)
    
    # æ§‹å»ºç™»å…¥é€£çµ
    login_url = f"https://app.yoursite.com/auth/magic?token={token}"
    
    await update.message.reply_text(
        f"ğŸ” **ç¶²é ç‰ˆç™»å…¥é€£çµ**\n\n"
        f"é»æ“Šä¸‹æ–¹é€£çµåœ¨ç€è¦½å™¨ä¸­ç™»å…¥ï¼š\n"
        f"[ç«‹å³ç™»å…¥]({login_url})\n\n"
        f"âš ï¸ æ­¤é€£çµå°‡åœ¨ 5 åˆ†é˜å¾Œå¤±æ•ˆï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup([[
            InlineKeyboardButton("ğŸŒ ç«‹å³ç™»å…¥", url=login_url)
        ]])
    )
```

#### æ–‡ä»¶ï¼š`api/routers/v2/auth.py`

```python
@router.post("/auth/magic-link/verify")
async def verify_magic_link(
    token: str,
    request: Request,
    db: Session = Depends(get_db)
):
    """
    é©—è­‰ Magic Link ä¸¦å‰µå»ºæœƒè©±
    """
    # æŸ¥æ‰¾ä»¤ç‰Œ
    magic_link = await db.query(MagicLinkToken).filter(
        MagicLinkToken.token == token,
        MagicLinkToken.is_used == False,
        MagicLinkToken.expires_at > datetime.utcnow()
    ).first()
    
    if not magic_link:
        raise HTTPException(401, "é€£çµå·²å¤±æ•ˆæˆ–å·²è¢«ä½¿ç”¨")
    
    # æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
    magic_link.is_used = True
    magic_link.used_at = datetime.utcnow()
    magic_link.ip_address = request.client.host
    magic_link.user_agent = request.headers.get("user-agent")
    await db.commit()
    
    # ç²å–ç”¨æˆ¶
    user = await get_user_by_tg_id(magic_link.user_id)
    
    # ç”Ÿæˆ JWT æœƒè©±ä»¤ç‰Œ
    access_token = create_access_token(
        data={"sub": str(user.tg_id), "type": "magic_link"},
        expires_delta=timedelta(days=7)
    )
    
    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user": user.to_dict(),
    }
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å‰µå»º `MagicLinkToken` è³‡æ–™è¡¨
- [ ] å¯¦ä½œ `/web_login` Bot å‘½ä»¤
- [ ] å‰µå»º Magic Link é©—è­‰ API
- [ ] å‰µå»ºå‰ç«¯ Magic Link ç™»å…¥é é¢
- [ ] å¯¦ä½œæœƒè©±åŒæ­¥
- [ ] æ·»åŠ ä»¤ç‰Œè‡ªå‹•æ¸…ç†ä»»å‹™

---

### 7.4 å Sybil é˜²ç¦¦ç³»çµ±

**ç›®æ¨™ï¼š** é˜»æ­¢æ©Ÿå™¨äººè¾²å ´æ¶ç©ºç´…åŒ…æ± ã€‚

#### è³‡æ–™åº«æ›´æ–°

```python
class DeviceFingerprint(Base):
    """è¨­å‚™æŒ‡ç´‹è¡¨"""
    __tablename__ = "device_fingerprints"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    fingerprint_id = Column(String(64), nullable=False, index=True)
    
    # è¨­å‚™ä¿¡æ¯
    device_info = Column(JSON, nullable=True)
    browser_info = Column(JSON, nullable=True)
    
    # é¢¨éšªè©•ä¼°
    confidence_score = Column(Numeric(5, 4), nullable=True)  # 0-1
    risk_level = Column(String(16), default="low")  # low, medium, high, critical
    
    # è¿½è¹¤
    first_seen = Column(DateTime, default=datetime.utcnow)
    last_seen = Column(DateTime, default=datetime.utcnow)
    request_count = Column(Integer, default=0)
    
    __table_args__ = (
        Index("ix_fingerprint_id", "fingerprint_id"),
        Index("ix_fingerprint_user", "user_id"),
    )


class IPSession(Base):
    """IP æœƒè©±è¿½è¹¤è¡¨"""
    __tablename__ = "ip_sessions"
    
    id = Column(Integer, primary_key=True)
    ip_address = Column(String(64), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    
    # æœƒè©±ä¿¡æ¯
    session_start = Column(DateTime, default=datetime.utcnow)
    last_activity = Column(DateTime, default=datetime.utcnow)
    is_active = Column(Boolean, default=True)
    
    # æ´»å‹•çµ±è¨ˆ
    packet_claims = Column(Integer, default=0)
    suspicious_actions = Column(Integer, default=0)
    
    __table_args__ = (
        Index("ix_ip_session_ip", "ip_address"),
        Index("ix_ip_session_active", "is_active"),
    )
```

#### æ–‡ä»¶ï¼š`api/middleware/anti_sybil.py`

```python
from fastapi import Request, HTTPException
from starlette.middleware.base import BaseHTTPMiddleware

class AntiSybilMiddleware(BaseHTTPMiddleware):
    """å Sybil æ”»æ“Šä¸­é–“ä»¶"""
    
    # é…ç½®
    NEW_ACCOUNT_AGE_HOURS = 24
    MAX_IP_SESSIONS = 5
    MAX_CLAIMS_PER_IP_PER_HOUR = 20
    
    async def dispatch(self, request: Request, call_next):
        # åªå°æ¶ç´…åŒ…è«‹æ±‚é€²è¡Œæª¢æŸ¥
        if "/packets/" in request.url.path and "/claim" in request.url.path:
            await self._check_sybil_risk(request)
        
        return await call_next(request)
    
    async def _check_sybil_risk(self, request: Request):
        """
        æª¢æŸ¥ Sybil é¢¨éšª
        """
        user = request.state.user
        ip_address = self._get_client_ip(request)
        fingerprint_id = request.headers.get("X-Fingerprint-ID")
        
        # è¦å‰‡ 1ï¼šæ–°å¸³æˆ¶ä¸”æœªå……å€¼
        if await self._is_new_account_without_deposit(user):
            raise HTTPException(
                403,
                detail={
                    "code": "SYBIL_NEW_ACCOUNT",
                    "message": "æ–°å¸³æˆ¶éœ€è¦ç­‰å¾… 24 å°æ™‚æˆ–å®Œæˆé¦–æ¬¡å……å€¼å¾Œæ‰èƒ½æ¶ç´…åŒ…"
                }
            )
        
        # è¦å‰‡ 2ï¼šåŒä¸€ IP éå¤šæ´»èºæœƒè©±
        active_sessions = await self._count_active_ip_sessions(ip_address)
        if active_sessions > self.MAX_IP_SESSIONS:
            raise HTTPException(
                403,
                detail={
                    "code": "SYBIL_IP_LIMIT",
                    "message": "æª¢æ¸¬åˆ°ç•°å¸¸æ´»å‹•ï¼Œè«‹ç¨å¾Œå†è©¦"
                }
            )
        
        # è¦å‰‡ 3ï¼šåŒä¸€ IP æ¶ç´…åŒ…æ¬¡æ•¸é™åˆ¶
        claims_count = await self._count_ip_claims_last_hour(ip_address)
        if claims_count > self.MAX_CLAIMS_PER_IP_PER_HOUR:
            raise HTTPException(
                429,
                detail={
                    "code": "SYBIL_RATE_LIMIT",
                    "message": "æ¶ç´…åŒ…æ¬¡æ•¸éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦"
                }
            )
        
        # è¦å‰‡ 4ï¼šè¨­å‚™æŒ‡ç´‹ç•°å¸¸
        if fingerprint_id:
            risk_level = await self._check_fingerprint_risk(fingerprint_id, user.id)
            if risk_level in ("high", "critical"):
                raise HTTPException(
                    403,
                    detail={
                        "code": "SYBIL_FINGERPRINT",
                        "message": "æª¢æ¸¬åˆ°é¢¨éšªè¡Œç‚ºï¼Œæ“ä½œå·²è¢«é˜»æ­¢"
                    }
                )
    
    async def _is_new_account_without_deposit(self, user) -> bool:
        """æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¸³æˆ¶ä¸”æœªå……å€¼"""
        account_age = datetime.utcnow() - user.created_at
        if account_age.total_seconds() < self.NEW_ACCOUNT_AGE_HOURS * 3600:
            # æª¢æŸ¥æ˜¯å¦æœ‰å……å€¼è¨˜éŒ„
            has_deposit = await db.query(Transaction).filter(
                Transaction.user_id == user.id,
                Transaction.type == "deposit",
                Transaction.status == "completed"
            ).first()
            return not has_deposit
        return False
    
    async def _count_active_ip_sessions(self, ip_address: str) -> int:
        """è¨ˆç®— IP æ´»èºæœƒè©±æ•¸"""
        cutoff = datetime.utcnow() - timedelta(minutes=30)
        return await db.query(func.count(IPSession.id)).filter(
            IPSession.ip_address == ip_address,
            IPSession.last_activity > cutoff,
            IPSession.is_active == True
        ).scalar()
    
    async def _check_fingerprint_risk(self, fingerprint_id: str, user_id: int) -> str:
        """è©•ä¼°è¨­å‚™æŒ‡ç´‹é¢¨éšª"""
        # æª¢æŸ¥æ­¤æŒ‡ç´‹æ˜¯å¦é—œè¯å¤šå€‹å¸³æˆ¶
        linked_users = await db.query(func.count(func.distinct(DeviceFingerprint.user_id))).filter(
            DeviceFingerprint.fingerprint_id == fingerprint_id
        ).scalar()
        
        if linked_users > 3:
            return "critical"
        elif linked_users > 1:
            return "high"
        
        return "low"
```

#### å‰ç«¯æ•´åˆï¼š`frontend/src/utils/fingerprint.ts`

```typescript
import FingerprintJS from '@fingerprintjs/fingerprintjs';

let fpPromise: Promise<any> | null = null;

export async function getDeviceFingerprint(): Promise<string> {
  if (!fpPromise) {
    fpPromise = FingerprintJS.load();
  }
  
  const fp = await fpPromise;
  const result = await fp.get();
  
  return result.visitorId;
}

// æ·»åŠ åˆ° API è«‹æ±‚é ­
export function setupFingerprintInterceptor(api: AxiosInstance) {
  api.interceptors.request.use(async (config) => {
    try {
      const fingerprint = await getDeviceFingerprint();
      config.headers['X-Fingerprint-ID'] = fingerprint;
    } catch (e) {
      console.warn('Failed to get fingerprint:', e);
    }
    return config;
  });
}
```

#### ä»»å‹™æ¸…å–®ï¼š
- [ ] å®‰è£ FingerprintJS Proï¼ˆæˆ–é–‹æºç‰ˆï¼‰
- [ ] å‰µå»º `DeviceFingerprint` è³‡æ–™è¡¨
- [ ] å‰µå»º `IPSession` è³‡æ–™è¡¨
- [ ] å¯¦ä½œ `AntiSybilMiddleware`
- [ ] åœ¨å‰ç«¯æ•´åˆæŒ‡ç´‹æ”¶é›†
- [ ] å‰µå»ºé¢¨éšªè©•åˆ†æ¼”ç®—æ³•
- [ ] æ·»åŠ ç®¡ç†å¾Œå°é¢¨éšªç›£æ§å„€è¡¨æ¿
- [ ] è¨­ç½® Prometheus æŒ‡æ¨™ç›£æ§

---

## ğŸ“Š æ›´æ–°å¾Œçš„æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®¢æˆ¶ç«¯                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Telegram Mini   â”‚   â”‚  H5 Web / PWA   â”‚   â”‚  åŸç”Ÿ Apps      â”‚           â”‚
â”‚  â”‚     App         â”‚   â”‚   (å¤–éƒ¨ç”¨æˆ¶)     â”‚   â”‚   (æœªä¾†)        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     â”‚
â”‚           â”‚  â”‚  ğŸ¦ è®Šè‰²é¾ UI å±¤                     â”‚  â”‚                     â”‚
â”‚           â”‚  â”‚  getPlatformRules()                 â”‚  â”‚                     â”‚
â”‚           â”‚  â”‚  iOS: éš±è—é‡‘èåŠŸèƒ½                   â”‚  â”‚                     â”‚
â”‚           â”‚  â”‚  Android/Web: å®Œæ•´åŠŸèƒ½              â”‚  â”‚                     â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                     â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                     â”‚
â”‚           â”‚  â”‚  ğŸ”’ è¨­å‚™æŒ‡ç´‹å±¤ (FingerprintJS)       â”‚  â”‚                     â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                     â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API é–˜é“ (Nginx)                                  â”‚
â”‚                     é€Ÿç‡é™åˆ¶ã€SSLã€è² è¼‰å‡è¡¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ›¡ï¸ å®‰å…¨èˆ‡åˆè¦å±¤                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å Sybil ä¸­é–“ä»¶                                    â”‚   â”‚
â”‚  â”‚  â€¢ æ–°å¸³æˆ¶æª¢æŸ¥ (24h + ç„¡å……å€¼)                                          â”‚   â”‚
â”‚  â”‚  â€¢ IP æœƒè©±é™åˆ¶ (> 5 æ´»èº)                                             â”‚   â”‚
â”‚  â”‚  â€¢ è¨­å‚™æŒ‡ç´‹é©—è­‰                                                       â”‚   â”‚
â”‚  â”‚  â€¢ é€Ÿç‡é™åˆ¶                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    æµå‹•æ€§ç®¡ç†æœå‹™                                      â”‚   â”‚
â”‚  â”‚  â€¢ Stars å†·å»æœŸ (21 å¤©)                                               â”‚   â”‚
â”‚  â”‚  â€¢ æµæ°´è§£é–è¦æ±‚                                                       â”‚   â”‚
â”‚  â”‚  â€¢ è³‡é‡‘ä¾†æºè¿½è¹¤                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             èªè­‰å±¤                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Telegram   â”‚  â”‚  Magic Link â”‚  â”‚  Particle   â”‚  â”‚   éŒ¢åŒ…      â”‚        â”‚
â”‚  â”‚  initData   â”‚  â”‚    JWT      â”‚  â”‚   Network   â”‚  â”‚   ç°½å      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                          [æ‡‰ç”¨å±¤ - åŒå‰]
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶çµæ§‹

```
c:\hbgm001\
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ anti_sybil.py           # ğŸ†• å Sybil ä¸­é–“ä»¶
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ liquidity_service.py    # ğŸ†• æµå‹•æ€§ç®¡ç†
â”‚   â””â”€â”€ routers/
â”‚       â””â”€â”€ v2/
â”‚           â””â”€â”€ auth.py             # ğŸ†• Magic Link èªè­‰
â”œâ”€â”€ bot/
â”‚   â””â”€â”€ handlers/
â”‚       â””â”€â”€ web_login.py            # ğŸ†• /web_login å‘½ä»¤
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ utils/
â”‚       â”‚   â”œâ”€â”€ platformRules.ts    # ğŸ†• å¹³å°è¦å‰‡å·¥å…·
â”‚       â”‚   â””â”€â”€ fingerprint.ts      # ğŸ†• è¨­å‚™æŒ‡ç´‹
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ ComplianceBanner.tsx # ğŸ†• åˆè¦æ©«å¹…
â””â”€â”€ shared/
    â””â”€â”€ database/
        â””â”€â”€ models.py               # ğŸ”„ æ›´æ–°ï¼šæ–°å¢è¡¨å’Œæ¬„ä½
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å¯©é–±æ­¤è¨ˆåŠƒ** ä¸¦ç¢ºèªç¯„åœ
2. **é–‹å§‹ç¬¬ä¸€éšæ®µ**ï¼šè³‡æ–™åº«é·ç§»
3. **è¨­ç½®é–‹ç™¼ç’°å¢ƒ** ä¸¦åŠ å…¥ Redis
4. **å‰µå»ºåŠŸèƒ½åˆ†æ”¯** é€²è¡Œä¸¦è¡Œé–‹ç™¼
5. **ğŸ†• å„ªå…ˆå¯¦æ–½å®‰å…¨èˆ‡åˆè¦å±¤** - é€™æ˜¯ä¸Šç·šå‰çš„é—œéµéœ€æ±‚

éœ€è¦æˆ‘é–‹å§‹å¯¦ä½œæŸå€‹ç‰¹å®šçµ„ä»¶å—ï¼Ÿ

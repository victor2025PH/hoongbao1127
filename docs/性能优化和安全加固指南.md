# 🚀 性能优化和安全加固指南

## 📊 性能优化

### 1. 慢查询分析

#### 运行分析脚本

```bash
# 在服务器上执行
cd /opt/luckyred
python3 scripts/py/analyze_slow_queries.py
```

**脚本功能**：
- 分析平均执行时间超过 100ms 的查询
- 识别未使用的索引
- 生成优化建议
- 分析表统计信息

#### 优化建议

根据分析结果：
1. **添加索引**：为常用查询字段添加索引
2. **优化查询**：重写慢查询，减少 JOIN 操作
3. **添加缓存**：缓存频繁查询的结果

### 2. Redis 缓存

#### 配置 Redis

在 `.env` 文件中添加：
```env
REDIS_URL=redis://localhost:6379/0
```

#### 使用缓存服务

```python
from api.services.cache_service import get_cache_service, cached

# 方式1：直接使用缓存服务
cache = get_cache_service()
await cache.set("key", "value", expire=300)  # 缓存5分钟
value = await cache.get("key")

# 方式2：使用装饰器
@cached(prefix="user_balance", expire=30)
async def get_user_balance(user_id: int):
    # 函数结果会自动缓存
    return balance
```

#### 已缓存的端点

- ✅ `/api/v1/wallet/balance` - 余额查询（缓存30秒）

### 3. 数据库索引优化

#### 执行索引优化脚本

```bash
# 在服务器上执行
cd /opt/luckyred
sudo -u postgres psql -d luckyred -f scripts/sql/optimize_indexes.sql
```

**索引优化包括**：
- 用户表索引（tg_id, username, referrer_id）
- 红包表索引（sender_id, status, currency, created_at）
- 红包领取表索引（packet_id, user_id）
- 账本条目表索引（user_id, currency, entry_type）
- 交易表索引（user_id, type, status）
- 复合索引优化

#### 检查索引使用情况

```sql
-- 查看索引使用统计
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

---

## 🔒 安全加固

### 1. 防火墙配置

#### 运行防火墙配置脚本

```bash
# 在服务器上执行（需要 root 权限）
cd /opt/luckyred
sudo bash scripts/sh/setup_firewall.sh
```

**配置内容**：
- 默认拒绝所有入站连接
- 允许 SSH (端口 22)
- 允许 HTTP (端口 80)
- 允许 HTTPS (端口 443)
- 限制 SSH 连接速率

#### 手动配置

```bash
# 启用 UFW
sudo ufw enable

# 允许端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# 查看状态
sudo ufw status
```

### 2. API 速率限制

#### 已配置的限制

速率限制中间件已自动启用，默认配置：

| 端点 | 限制 | 时间窗口 |
|------|------|----------|
| 抢红包 | 10 次 | 60 秒 |
| 发红包 | 20 次 | 60 秒 |
| 登录 | 5 次 | 60 秒 |
| 签到 | 1 次 | 24 小时 |
| 充值 | 10 次 | 5 分钟 |
| 提现 | 5 次 | 5 分钟 |
| 其他端点 | 60 次 | 60 秒 |

#### 自定义限制

编辑 `api/middleware/rate_limit.py` 中的 `endpoint_limits` 字典。

#### 响应头

速率限制响应包含以下头：
- `X-RateLimit-Limit`: 限制次数
- `X-RateLimit-Remaining`: 剩余次数
- `X-RateLimit-Reset`: 重置时间戳

### 3. 监控告警

#### 告警服务

告警服务已集成，自动监控：
- 数据库连接状态
- Redis 连接状态
- 错误率
- 慢请求

#### 配置告警

编辑 `api/services/alert_service.py` 以添加：
- 邮件通知
- Telegram Bot 通知
- Webhook 通知

#### 手动触发告警检查

```python
from api.services.alert_service import get_alert_service

alert_service = get_alert_service()
await alert_service.check_system_health()
```

---

## 📈 性能监控

### 1. 查看慢请求

```bash
# 查看超过1秒的请求
sudo journalctl -u luckyred-api | grep -E "Process-Time.*[1-9]\.[0-9]+s"
```

### 2. 查看缓存命中率

```bash
# Redis 缓存统计
redis-cli INFO stats | grep keyspace
```

### 3. 数据库性能

```bash
# 查看数据库连接数
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"

# 查看慢查询
sudo -u postgres psql -d luckyred -c "
SELECT query, calls, mean_exec_time 
FROM pg_stat_statements 
WHERE mean_exec_time > 100 
ORDER BY mean_exec_time DESC 
LIMIT 10;
"
```

---

## 🔍 安全检查清单

### 基础安全

- [ ] 防火墙已配置
- [ ] 只开放必要端口
- [ ] SSH 使用密钥认证
- [ ] 定期更新系统

### 应用安全

- [ ] API 速率限制已启用
- [ ] HTTPS 已配置
- [ ] CORS 已正确配置
- [ ] 敏感信息已加密

### 数据安全

- [ ] 数据库备份已配置
- [ ] 密码强度要求
- [ ] SQL 注入防护（使用 ORM）
- [ ] XSS 防护

### 监控告警

- [ ] 错误日志监控
- [ ] 性能监控
- [ ] 告警通知已配置
- [ ] 定期健康检查

---

## 🛠️ 故障排查

### 缓存问题

```bash
# 清空缓存
redis-cli FLUSHDB

# 检查 Redis 连接
redis-cli PING
```

### 速率限制问题

```bash
# 查看速率限制日志
sudo journalctl -u luckyred-api | grep "Rate limit"
```

### 性能问题

```bash
# 运行慢查询分析
python3 scripts/py/analyze_slow_queries.py

# 检查数据库索引
sudo -u postgres psql -d luckyred -c "\d+ users"
```

---

## 📝 最佳实践

### 性能优化

1. **缓存策略**
   - 频繁查询的数据：缓存 30-300 秒
   - 用户余额：缓存 30 秒
   - 静态数据：缓存更长时间

2. **数据库优化**
   - 定期运行 `ANALYZE` 更新统计信息
   - 定期清理死行（`VACUUM`）
   - 监控索引使用情况

3. **查询优化**
   - 避免 N+1 查询
   - 使用 `select_related` 或 `joinedload`
   - 限制返回的数据量

### 安全加固

1. **定期更新**
   - 系统更新
   - 依赖包更新
   - 安全补丁

2. **监控和日志**
   - 定期检查日志
   - 设置告警阈值
   - 保留日志备份

3. **访问控制**
   - 最小权限原则
   - 定期审查权限
   - 使用强密码

---

## 🔗 相关文档

- [部署运维文档](./部署运维文档.md)
- [API 接口文档](./API接口文档.md)
- [用户使用指南](./用户使用指南.md)


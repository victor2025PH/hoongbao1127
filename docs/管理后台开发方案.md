# 🎯 Lucky Red 统一管理后台开发方案

## 📋 方案概述

### 项目背景
当前系统包含三个独立模块：
- **Admin 后台**：基础的用户管理和充值功能
- **Telegram Bot**：机器人命令和交互管理
- **MiniApp API**：前端应用的后端服务

需要整合为一个**功能强大、统一管理**的后台系统。

---

## 🏗️ 技术架构方案

### 方案 A：单页面应用（SPA）架构 ⭐ 推荐

**技术栈：**
- **前端框架**：React 18 + TypeScript + Vite
- **UI 组件库**：Ant Design / Shadcn UI / Tailwind CSS
- **状态管理**：Zustand / Redux Toolkit
- **数据请求**：React Query (TanStack Query)
- **路由**：React Router v6
- **图表可视化**：Recharts / ECharts
- **实时通信**：WebSocket (Socket.io)

**后端架构：**
- **API 框架**：FastAPI (现有)
- **认证授权**：JWT + RBAC (角色权限控制)
- **数据库**：PostgreSQL (现有)
- **缓存**：Redis (可选，用于会话和实时数据)

**优势：**
- ✅ 现代化用户体验
- ✅ 组件化开发，易于维护
- ✅ 丰富的 UI 组件生态
- ✅ 支持实时数据更新
- ✅ 响应式设计，支持移动端

**劣势：**
- ⚠️ 开发周期较长
- ⚠️ 需要前端开发资源

---

### 方案 B：服务端渲染（SSR）架构

**技术栈：**
- **框架**：Next.js / Nuxt.js
- **UI**：Tailwind CSS + Headless UI
- **后端**：FastAPI (现有)

**优势：**
- ✅ SEO 友好
- ✅ 首屏加载快
- ✅ 开发相对简单

**劣势：**
- ⚠️ 交互体验不如 SPA
- ⚠️ 实时更新需要额外处理

---

### 方案 C：混合架构（渐进式升级）

**第一阶段**：基于现有 HTML 模板增强
- 使用 Alpine.js / HTMX 增强交互
- 保持现有 FastAPI + Jinja2 模板

**第二阶段**：逐步迁移到 SPA
- 关键模块先迁移（用户管理、统计）
- 其他模块保持 SSR

**优势：**
- ✅ 快速上线
- ✅ 渐进式升级
- ✅ 风险可控

---

## 📦 功能模块设计

### 1. 仪表盘（Dashboard）

#### 1.1 核心指标卡片
- **用户指标**
  - 总用户数
  - 今日新增用户
  - 活跃用户（7天/30天）
  - 在线用户数（实时）
  
- **业务指标**
  - 总红包数
  - 今日红包数
  - 总交易额
  - 今日交易额
  - 平均红包金额
  
- **财务指标**
  - 总充值金额
  - 总提现金额
  - 平台余额
  - 各币种余额分布

#### 1.2 数据可视化
- **趋势图表**
  - 用户增长趋势（折线图）
  - 交易额趋势（面积图）
  - 红包发放趋势（柱状图）
  
- **分布图表**
  - 用户等级分布（饼图）
  - 币种使用分布（饼图）
  - 地区分布（地图，如果有数据）

#### 1.3 实时监控
- WebSocket 实时推送关键指标
- 系统状态监控（API、Bot、数据库）
- 异常告警提示
- Telegram Bot 在线状态实时显示

#### 1.4 快捷操作面板
- **常用操作**
  - 快速发送消息（选择用户/群组）
  - 快速查看用户详情（输入 Telegram ID）
  - 快速查看群组详情（输入群组 ID）
  - 快速充值（输入用户 ID 和金额）
- **最近操作**
  - 最近查看的用户
  - 最近操作的群组
  - 最近发送的消息

---

### 2. 用户管理（User Management）

#### 2.1 用户列表
- **搜索和筛选**
  - 按 Telegram ID、用户名、姓名搜索
  - 按注册时间、等级、状态筛选
  - 高级筛选（余额范围、活跃度等）
  
- **列表展示**
  - 用户基本信息（ID、用户名、头像）
  - 余额信息（USDT、TON、Stars、Points）
  - 等级和经验值
  - 注册时间、最后活跃时间
  - 状态标识（正常/封禁/管理员）
  
- **批量操作**
  - 批量封禁/解封
  - 批量发送消息
  - 批量导出数据

#### 2.2 用户详情
- **基本信息**
  - 完整用户资料
  - **Telegram ID 显示**（突出显示，一键复制）
  - 用户名、姓名、头像
  - 绑定信息（机器人绑定状态）
  - 邀请关系（邀请人、被邀请人列表）
  - **快速操作按钮**
    - 发送 Telegram 消息
    - 查看 Telegram 资料（t.me 链接）
    - 添加到群组
  
- **财务信息**
  - 各币种余额
  - 交易记录（充值、提现、红包）
  - 余额变动历史
  
- **行为数据**
  - 红包发送/领取记录
  - 签到记录
  - 活跃度统计
  - 群组参与情况
  
- **操作记录**
  - 管理员操作历史
  - 账户变更日志
  - Telegram 消息发送记录

#### 2.3 用户操作
- **余额管理**
  - 充值/扣款（支持多币种）
  - 余额调整记录
  - 批量充值
  
- **账户管理**
  - 封禁/解封
  - 设置/取消管理员
  - 重置密码（如果有）
  - 删除账户（软删除）
  
- **Telegram 操作** ⭐ 增强
  - **发送消息**
    - 发送文本消息
    - 发送媒体文件
    - 发送红包通知
    - 预览消息效果
  - **群组操作**
    - 查看用户所在群组
    - 邀请用户加入群组
    - 从群组移除用户（如果 Bot 有权限）
  - **批量操作**
    - 批量发送消息
    - 批量邀请到群组

---

### 3. Telegram 机器人管理（Telegram Bot Management）

> **定位说明**：Telegram Bot 用于管理群组、给用户发送消息，以及处理 MiniApp 无法实现的功能。

#### 3.1 机器人状态监控
- **运行状态**
  - Bot 在线/离线状态（实时）
  - 最后心跳时间
  - Telegram API 连接状态
  - Bot 信息展示（用户名、ID、描述）
  
- **性能指标**
  - 消息处理速度（TPS）
  - 消息发送成功率
  - API 调用错误率
  - 响应时间统计

#### 3.2 群组管理（Group Management）⭐ 核心功能
- **群组列表**
  - 所有 Bot 加入的群组
  - 群组信息（ID、标题、类型、成员数）
  - Bot 在群组中的角色（成员/管理员/创建者）
  - 群组状态（正常/已离开/被踢出）
  - 快速查看群组 Telegram ID
  
- **群组详情**
  - 完整群组信息
  - 成员列表（支持搜索）
  - Bot 权限状态
  - 群组设置（如果 Bot 是管理员）
  - 群组统计（消息数、活跃度）
  
- **群组操作**
  - **发送消息到群组**
    - 文本消息
    - 图片/视频/文件
    - 红包链接
    - 自定义键盘按钮
  - **批量操作**
    - 批量发送消息
    - 批量邀请用户
    - 批量设置权限
  - **群组设置**
    - 设置 Bot 为管理员
    - 配置群组功能开关
    - 设置欢迎消息
    - 设置自动回复规则

#### 3.3 用户消息管理（User Message Management）⭐ 核心功能
- **消息发送**
  - **单用户发送**
    - 选择用户（搜索 Telegram ID 或用户名）
    - 发送文本消息
    - 发送媒体（图片、视频、文档）
    - 发送红包通知
    - 发送自定义键盘
    - 预览消息效果
  - **批量发送**
    - 选择多个用户（支持筛选条件）
    - 消息模板管理
    - 定时发送
    - 发送进度跟踪
  - **消息模板**
    - 创建/编辑模板
    - 变量替换（用户名、余额等）
    - 模板分类管理
    - 模板使用统计

- **消息记录**
  - 所有发送的消息历史
  - 按用户、群组、时间筛选
  - 消息状态（已发送/失败/待发送）
  - 消息内容搜索
  - 查看消息详情（发送时间、接收者、状态）

#### 3.4 命令管理（Command Management）
- **命令列表**
  - 所有可用命令（/start, /wallet, /send, /checkin 等）
  - 命令使用统计（调用次数、用户数）
  - 命令响应时间
  - 命令错误率
  
- **命令配置**
  - 启用/禁用命令
  - 修改命令描述
  - 设置命令权限（管理员/普通用户）
  - 自定义命令响应
  - 命令别名设置

#### 3.5 自动化任务（Automation Tasks）
- **定时任务**
  - 定时发送消息（每日签到提醒、活动通知）
  - 定时统计数据
  - 定时清理数据
  - Cron 表达式配置
  
- **触发规则**
  - 用户注册自动欢迎
  - 红包领取自动通知
  - 余额变动提醒
  - 关键词自动回复
  - 事件触发动作（Webhook）

#### 3.6 机器人配置
- **基础配置**
  - Bot Token 管理（加密存储）
  - Bot 用户名和描述
  - Bot 头像设置
  - Webhook 配置（如果使用）
  
- **功能开关**
  - 红包功能开关
  - 签到功能开关
  - 钱包功能开关
  - 群组管理功能开关
  
- **高级配置**
  - API 限流设置
  - 重试机制配置
  - 错误处理策略

#### 3.7 Telegram ID 工具集 ⭐ 新增
- **ID 查询工具**
  - 输入用户名/链接，快速获取 Telegram ID
  - 输入群组链接，获取群组 ID
  - 批量查询 ID
  - ID 格式转换工具
  
- **快速操作**
  - 复制 Telegram ID（一键复制）
  - 生成 t.me 链接
  - 生成群组邀请链接
  - 验证 ID 有效性

#### 3.8 群组数据分析
- **活跃度分析**
  - 群组消息趋势
  - 用户参与度
  - 热门时间段
  - 活跃用户排行
  
- **红包分析**
  - 群组红包统计
  - 红包参与率
  - 平均领取金额

---

### 4. MiniApp 管理

#### 4.1 API 监控
- **接口统计**
  - API 调用量
  - 接口响应时间
  - 错误率统计
  
- **接口管理**
  - 接口列表和文档
  - 接口开关控制
  - 限流配置

#### 4.2 前端管理
- **版本管理**
  - 前端版本列表
  - 版本发布记录
  - 回滚功能
  
- **配置管理**
  - 前端配置项
  - 功能开关
  - A/B 测试配置

#### 4.3 数据统计
- **使用统计**
  - 页面访问量
  - 功能使用率
  - 用户留存率
  
- **性能监控**
  - 页面加载时间
  - 错误日志
  - 用户反馈

---

### 5. 红包管理（Red Packet Management）

#### 5.1 红包列表
- **筛选和搜索**
  - 按发送者、群组、状态筛选
  - 按金额、时间范围筛选
  - UUID 搜索
  
- **列表展示**
  - 红包基本信息
  - 发送者信息
  - 领取情况
  - 状态（进行中/已完成/已过期）

#### 5.2 红包详情
- **基本信息**
  - 红包类型、金额、数量
  - 发送者和群组
  - 创建时间、过期时间
  
- **领取记录**
  - 领取者列表
  - 领取金额和时间
  - 领取顺序

#### 5.3 红包操作
- **管理操作**
  - 手动退款
  - 延长过期时间
  - 强制完成
  - 删除红包

#### 5.4 红包统计
- **数据统计**
  - 总红包数
  - 总金额
  - 平均金额
  - 领取率
  
- **趋势分析**
  - 红包发放趋势
  - 热门时间段
  - 热门群组
  
- **群组红包分析**
  - 各群组红包统计
  - 群组活跃度排行
  - 群组 Telegram ID 显示

---

### 6. 交易管理（Transaction Management）

#### 6.1 交易列表
- **筛选和搜索**
  - 按用户、类型、币种筛选
  - 按时间范围筛选
  - 交易 ID 搜索
  
- **列表展示**
  - 交易基本信息
  - 用户信息
  - 金额和币种
  - 交易状态

#### 6.2 交易详情
- **完整信息**
  - 交易类型和描述
  - 余额变动
  - 关联记录（红包、充值等）
  - 时间戳

#### 6.3 交易操作
- **管理操作**
  - 标记为异常
  - 手动调整
  - 导出数据

#### 6.4 财务统计
- **收支统计**
  - 总收入/支出
  - 各币种统计
  - 按时间段统计
  - 按用户统计
  - 按群组统计
  
- **财务报表** ⭐ 增强
  - **报表类型**
    - 日报、周报、月报、自定义时间段
    - 用户财务报表
    - 群组财务报表
    - 交易明细报表
  - **导出功能**
    - 导出 Excel（.xlsx）
    - 导出 CSV
    - 导出 PDF（带图表）
    - 批量导出
    - 定时自动导出（邮件发送）
  - **报表内容**
    - 数据表格
    - 图表可视化
    - 统计摘要
    - 包含 Telegram ID 和群组 ID

---

### 7. 系统配置（System Settings）

#### 7.1 基础配置
- **系统信息**
  - 系统版本
  - 数据库信息
  - 服务器信息
  
- **环境变量**
  - 配置项管理
  - 敏感信息加密显示
  - 配置修改记录

#### 7.2 功能配置
- **业务配置**
  - 红包配置（最小/最大金额、数量限制）
  - 签到配置（奖励规则）
  - 邀请配置（返佣比例）
  
- **安全配置**
  - API 限流配置
  - IP 白名单/黑名单
  - 登录安全策略

#### 7.3 通知配置
- **通知渠道**
  - Telegram 通知配置
  - 邮件通知配置（可选）
  - Webhook 配置
  
- **通知规则**
  - 告警规则
  - 通知模板

---

### 8. 日志和监控（Logs & Monitoring）

#### 8.1 系统日志
- **日志查看**
  - 按级别筛选（INFO、WARNING、ERROR）
  - 按模块筛选
  - 按时间范围筛选
  - 关键词搜索
  
- **日志详情**
  - 完整日志信息
  - 堆栈跟踪
  - 上下文信息

#### 8.2 操作日志
- **管理员操作**
  - 所有管理员操作记录
  - 操作类型、操作人、时间
  - 操作前后对比
  
- **审计追踪**
  - 敏感操作记录
  - 数据变更记录

#### 8.3 性能监控
- **系统性能**
  - CPU、内存使用率
  - 数据库连接数
  - API 响应时间
  
- **业务指标**
  - 实时用户数
  - 请求量
  - 错误率

#### 8.4 告警管理
- **告警规则**
  - 自定义告警规则
  - 告警阈值设置
  
- **告警记录**
  - 告警历史
  - 告警处理记录

---

### 9. 权限管理（Permission Management）

#### 9.1 角色管理
- **角色列表**
  - 超级管理员
  - 运营管理员
  - 财务管理员
  - 客服管理员
  - 只读管理员
  
- **角色权限**
  - 模块权限配置
  - 操作权限配置
  - 数据权限配置

#### 9.2 管理员管理
- **管理员列表**
  - 管理员信息
  - 角色分配
  - 状态管理
  
- **管理员操作**
  - 添加/删除管理员
  - 修改权限
  - 重置密码

#### 9.3 权限控制
- **细粒度权限**
  - 页面访问权限
  - 按钮操作权限
  - 数据查看权限

---

## 🎨 UI/UX 设计建议

### 设计风格
- **现代化**：采用卡片式布局，圆角、阴影、渐变
- **深色主题**：符合技术后台的视觉习惯
- **响应式**：支持桌面、平板、手机访问
- **一致性**：统一的颜色、字体、间距规范

### 布局结构
```
┌─────────────────────────────────────────┐
│  Header (Logo + 用户信息 + 通知)        │
├──────────┬──────────────────────────────┤
│          │                              │
│ Sidebar  │  Main Content Area           │
│ (导航)   │  (动态内容)                  │
│          │                              │
│          │                              │
└──────────┴──────────────────────────────┘
```

### 关键页面
1. **登录页**：简洁、安全
2. **仪表盘**：信息丰富、可视化
3. **列表页**：表格 + 筛选 + 分页
4. **详情页**：标签页 + 卡片布局
5. **表单页**：清晰的步骤和验证

---

## 🔐 安全方案

### 认证授权
- **JWT Token**：无状态认证
- **Refresh Token**：自动刷新机制
- **RBAC**：基于角色的访问控制
- **操作审计**：记录所有敏感操作

### 数据安全
- **敏感信息加密**：密码、Token 等
- **SQL 注入防护**：使用 ORM 参数化查询
- **XSS 防护**：输入验证和输出转义
- **CSRF 防护**：Token 验证

### API 安全
- **限流**：防止 API 滥用
- **IP 白名单**：管理后台 IP 限制
- **HTTPS**：强制使用 HTTPS
- **API 密钥**：用于服务间通信

---

## 📊 数据库设计扩展

### 新增表结构

#### 1. admin_users (管理员表)
```sql
- id
- username (登录用户名)
- password_hash (密码哈希)
- email
- role_id (角色ID)
- is_active
- last_login_at
- created_at
- updated_at
```

#### 2. roles (角色表)
```sql
- id
- name (角色名称)
- description
- permissions (JSON, 权限列表)
- created_at
- updated_at
```

#### 3. admin_logs (操作日志表)
```sql
- id
- admin_id (操作管理员ID)
- action_type (操作类型)
- resource_type (资源类型)
- resource_id (资源ID)
- old_data (JSON, 操作前数据)
- new_data (JSON, 操作后数据)
- ip_address
- user_agent
- created_at
```

#### 4. system_configs (系统配置表)
```sql
- id
- key (配置键)
- value (配置值, JSON)
- description
- updated_by
- updated_at
```

#### 5. bot_configs (机器人配置表)
```sql
- id
- bot_id
- command_name
- is_enabled
- config (JSON)
- updated_at
```

#### 6. api_logs (API日志表)
```sql
- id
- endpoint
- method
- user_id
- request_data (JSON)
- response_data (JSON)
- status_code
- response_time
- ip_address
- created_at
```

---

## 🚀 开发计划

### 第一阶段：基础框架（1-2周）
- [ ] 项目初始化和技术栈搭建
- [ ] 认证授权系统
- [ ] 基础布局和导航
- [ ] 仪表盘基础数据展示
- [ ] Telegram ID 工具集基础功能

### 第二阶段：核心功能（2-3周）
- [ ] 用户管理模块（含 Telegram 操作）
- [ ] 红包管理模块
- [ ] 交易管理模块
- [ ] 机器人状态监控
- [ ] 群组管理基础功能

### 第三阶段：高级功能（2-3周）
- [ ] 消息发送功能（单用户/批量）
- [ ] 机器人命令管理
- [ ] 自动化任务
- [ ] 系统配置管理
- [ ] 日志和监控
- [ ] 权限管理

### 第四阶段：报表和优化（2周）
- [ ] 报表系统（含导出功能）
- [ ] Telegram ID 工具增强
- [ ] 性能优化
- [ ] 安全加固
- [ ] 全面测试
- [ ] 文档编写

---

## 💰 成本评估

### 开发成本
- **人力**：1-2 名全栈开发，6-10 周
- **技术栈**：开源免费（React、FastAPI等）

### 运维成本
- **服务器**：现有服务器可复用
- **数据库**：现有 PostgreSQL
- **CDN**：可选，用于静态资源加速

---

## ❓ 需要确认的问题

1. **技术选型**
   - 是否采用方案 A（SPA）？
   - UI 组件库选择（Ant Design / Shadcn UI）？

2. **功能优先级**
   - 哪些功能是必须的？
   - 哪些功能可以后续迭代？

3. **权限设计**
   - 需要几级权限？
   - 是否需要数据权限（如只能查看自己负责的用户）？

4. **数据统计**
   - 需要哪些维度的数据分析？
   - 是否需要导出报表功能？

5. **实时性要求**
   - 哪些数据需要实时更新？
   - WebSocket 的优先级？

---

## 📝 总结

本方案提供了一个**功能完整、技术先进、易于扩展**的统一管理后台解决方案。建议采用**方案 A（SPA架构）**，使用 **React + TypeScript + Ant Design** 技术栈，分阶段实施，确保快速上线和持续迭代。

**下一步行动：**
1. ✅ 技术方案已确认（方案 A）
2. ✅ 数据库表结构已设计（含新增表）
3. 创建项目脚手架
4. 开始第一阶段开发

---

## 📝 技术实现细节

### 前端技术栈（方案 A）
```json
{
  "框架": "React 18 + TypeScript",
  "构建工具": "Vite",
  "UI组件库": "Ant Design 5.x",
  "状态管理": "Zustand",
  "数据请求": "React Query (TanStack Query)",
  "路由": "React Router v6",
  "图表": "Recharts / ECharts",
  "表格": "Ant Design Table (支持导出)",
  "实时通信": "WebSocket (原生)",
  "日期处理": "dayjs",
  "工具库": "lodash-es"
}
```

### 后端 API 扩展
需要新增的 API 端点：

#### Telegram 相关
- `POST /api/v1/telegram/send-message` - 发送消息
- `POST /api/v1/telegram/send-batch` - 批量发送
- `GET /api/v1/telegram/groups` - 获取群组列表
- `GET /api/v1/telegram/groups/{chat_id}` - 获取群组详情
- `POST /api/v1/telegram/groups/{chat_id}/send` - 发送群组消息
- `GET /api/v1/telegram/messages` - 消息记录
- `GET /api/v1/telegram/resolve-id` - 解析 Telegram ID

#### 报表相关
- `POST /api/v1/reports/generate` - 生成报表
- `GET /api/v1/reports/{report_id}` - 获取报表
- `GET /api/v1/reports/{report_id}/download` - 下载报表
- `GET /api/v1/reports` - 报表列表

#### 模板相关
- `GET /api/v1/templates` - 模板列表
- `POST /api/v1/templates` - 创建模板
- `PUT /api/v1/templates/{id}` - 更新模板
- `DELETE /api/v1/templates/{id}` - 删除模板

### Telegram Bot API 集成
需要在后端实现 Telegram Bot API 封装：

```python
# api/services/telegram_service.py
class TelegramService:
    async def send_message(self, chat_id, text, **kwargs)
    async def send_photo(self, chat_id, photo, **kwargs)
    async def get_chat(self, chat_id)
    async def get_chat_member(self, chat_id, user_id)
    async def resolve_username(self, username)
    # ... 更多方法
```

---

**方案制定时间**：2024年11月  
**方案版本**：v2.1（最终版）  
**更新内容**：
- ✅ 明确机器人管理定位（Telegram Bot，用于群组管理和消息发送）
- ✅ 增强群组管理功能（列表、详情、操作、统计）
- ✅ 增强消息发送功能（单用户/批量/模板/定时）
- ✅ 添加 Telegram ID 工具集（ID 查询、转换、验证）
- ✅ 增强报表导出功能（Excel/CSV/PDF/JSON，支持自定义字段）
- ✅ 添加 15 个创新功能（智能分析、活动管理、客服、风控等）
- ✅ 完善数据库设计（新增 5 个表）
- ✅ 添加 Telegram 快捷操作面板
- ✅ 添加工作流自动化
- ✅ 添加数据分析实验室

---

## 🎨 UI/UX 设计亮点

### Telegram ID 显示规范
- **突出显示**：所有 Telegram ID 和群组 ID 使用特殊样式（如：`#123456789`）
- **一键复制**：每个 ID 旁边有复制按钮，点击即可复制
- **格式统一**：所有 ID 统一格式显示，便于识别
- **快速跳转**：点击 ID 可快速跳转到 Telegram（t.me 链接）

### 报表导出界面
- **导出按钮**：每个列表页面都有导出按钮
- **导出选项**：
  - 选择导出格式（Excel/CSV/PDF）
  - 选择导出字段（自定义）
  - 选择数据范围（当前页/全部/筛选结果）
- **导出进度**：显示导出进度条
- **导出历史**：查看历史导出记录，可重新下载

### Telegram 操作界面
- **消息发送界面**
  - 用户选择器（支持搜索 Telegram ID/用户名）
  - 消息编辑器（支持 Markdown、媒体）
  - 预览功能
  - 发送历史
- **群组管理界面**
  - 群组卡片展示
  - 快速操作按钮（发送消息、查看详情）
  - 群组统计图表

---

## 📊 报表功能详细设计

### 报表类型

#### 1. 用户报表
- **用户列表报表**
  - 基本信息（ID、Telegram ID、用户名、姓名）
  - 财务信息（各币种余额）
  - 行为数据（等级、经验、签到天数）
  - 统计信息（红包发送/领取数、交易次数）
  
- **用户行为报表**
  - 活跃度分析
  - 使用习惯分析
  - 流失风险分析

#### 2. 群组报表
- **群组列表报表**
  - 群组信息（ID、标题、类型、成员数）
  - Bot 状态
  - 活跃度统计
  
- **群组活动报表**
  - 红包统计
  - 消息统计
  - 用户参与度

#### 3. 财务报表
- **交易明细报表**
  - 所有交易记录
  - 包含 Telegram ID 和群组 ID
  - 交易类型、金额、时间
  
- **财务报表**
  - 收支汇总
  - 各币种统计
  - 趋势分析图表

#### 4. 红包报表
- **红包明细报表**
  - 红包信息（UUID、金额、数量）
  - 发送者信息（含 Telegram ID）
  - 群组信息（含群组 ID）
  - 领取记录

### 报表导出功能
- **导出格式**
  - Excel：支持多工作表、公式、图表
  - CSV：纯数据，便于导入其他系统
  - PDF：带格式，适合打印和分享
  - JSON：结构化数据，便于程序处理

- **导出选项**
  - 字段选择（自定义导出哪些列）
  - 数据筛选（只导出筛选后的数据）
  - 时间范围（自定义时间段）
  - 分页导出（大数据量分批导出）

- **导出管理**
  - 导出任务队列
  - 导出进度跟踪
  - 导出历史记录
  - 导出文件下载（7天有效期）

---

## 🔧 技术实现要点

### Telegram Bot API 集成
```python
# 需要实现的核心功能
class TelegramBotService:
    # 消息发送
    async def send_message(chat_id, text, **kwargs)
    async def send_photo(chat_id, photo, caption=None, **kwargs)
    async def send_document(chat_id, document, **kwargs)
    
    # 群组管理
    async def get_chat(chat_id)
    async def get_chat_member(chat_id, user_id)
    async def get_chat_administrators(chat_id)
    async def get_chat_members_count(chat_id)
    
    # ID 解析
    async def resolve_username(username) -> int  # 用户名转 ID
    async def get_chat_by_link(link) -> dict  # 链接获取群组信息
    
    # 批量操作
    async def send_batch_messages(chat_ids, message, **kwargs)
```

### 报表生成服务
```python
# 报表生成服务
class ReportService:
    async def generate_excel(data, columns, filename)
    async def generate_csv(data, columns, filename)
    async def generate_pdf(data, template, filename)
    async def generate_json(data, filename)
    
    # 异步生成（大数据量）
    async def generate_async(report_type, params) -> str  # 返回任务ID
    async def get_report_status(task_id) -> dict
    async def download_report(report_id) -> bytes
```

### 前端组件设计
```typescript
// Telegram ID 显示组件
<TelegramIdDisplay 
  id={user.tg_id} 
  type="user" 
  showCopy={true}
  showLink={true}
/>

// 报表导出组件
<ExportButton 
  data={tableData}
  columns={columns}
  formats={['excel', 'csv', 'pdf']}
  onExport={(format, options) => {...}}
/>

// 消息发送组件
<TelegramMessageSender
  onSend={(chatId, message, options) => {...}}
  templates={messageTemplates}
  preview={true}
/>
```

---

**方案制定时间**：2024年11月  
**方案版本**：v2.1（最终版）


# 全自動部署系統 - 使用說明

## 📋 功能說明

這個全自動部署系統包含以下改進功能：

### ✅ 1. 自動檢查關鍵文件是否在 Git 中

**功能**:
- 自動檢查關鍵文件（`api/routers/chats.py`, `api/main.py`）是否在 Git 中
- 如果文件不在 Git 中，自動添加到暫存區
- 檢查是否有未提交的更改

**執行步驟**:
1. 檢查每個關鍵文件是否在 Git 中
2. 識別未提交的文件
3. 自動添加未提交的文件

---

### ✅ 2. 自動驗證服務器文件狀態

**功能**:
- 自動連接到服務器
- 檢查服務器上關鍵文件是否存在
- 檢查服務器當前代碼版本
- 檢查 API 服務運行狀態

**執行步驟**:
1. 連接到服務器
2. 檢查關鍵文件是否存在
3. 檢查服務狀態
4. 生成驗證報告

---

### ✅ 3. 自動執行服務器更新

**功能**:
- 自動更新服務器代碼
- 自動重啟 API 服務
- 自動驗證更新結果
- 自動檢查服務狀態和錯誤日誌

**執行步驟**:
1. 更新服務器代碼（`git fetch` + `git reset --hard`）
2. 驗證關鍵文件是否存在
3. 重啟 API 服務
4. 檢查服務狀態
5. 查看錯誤日誌

---

## 🚀 使用方法

### 方法 1: 使用批處理文件（推薦）

**Windows**:
```batch
執行全自動部署.bat
```

**或者直接雙擊** `執行全自動部署.bat` 文件

---

### 方法 2: 使用 PowerShell

```powershell
cd C:\hbgm001
powershell -ExecutionPolicy Bypass -File "全自動部署-完整版.ps1"
```

---

## 📊 執行流程

### 完整流程

1. **步驟 1: 自動檢查關鍵文件是否在 Git 中**
   - 檢查 `api/routers/chats.py`
   - 檢查 `api/main.py`
   - 檢查未提交的更改

2. **步驟 2: 自動添加並提交關鍵文件**
   - 如果文件不在 Git 中，自動添加
   - 自動提交更改

3. **步驟 3: 本地構建測試**
   - 執行 `npm run build`
   - 檢查構建錯誤

4. **步驟 4: 推送到 GitHub**
   - 執行 `git push origin master`
   - 驗證推送結果

5. **步驟 5: 驗證推送成功**
   - 對比本地和遠程提交
   - 驗證關鍵文件是否在 Git 中

6. **步驟 6: 自動驗證服務器文件狀態**
   - 連接到服務器
   - 檢查關鍵文件是否存在
   - 檢查服務狀態

7. **步驟 7: 自動執行服務器更新**
   - 更新服務器代碼
   - 驗證關鍵文件
   - 重啟 API 服務
   - 檢查服務狀態和錯誤日誌

---

## 📋 生成的報告

### 報告格式

系統會自動生成三種格式的報告：

1. **CSV 格式** (`部署報告-YYYYMMDD-HHMMSS.csv`)
   - 適合在 Excel 中打開
   - 包含所有步驟的詳細信息

2. **JSON 格式** (`部署報告-YYYYMMDD-HHMMSS.json`)
   - 適合程序化處理
   - 包含完整的結構化數據

3. **Markdown 格式** (`部署報告-YYYYMMDD-HHMMSS.md`)
   - 適合閱讀和分享
   - 包含詳細的分析和說明

---

## ⚙️ 配置說明

### 服務器配置

在 `全自動部署-完整版.ps1` 中修改：

```powershell
$serverIP = "165.154.254.99"  # 服務器 IP 地址
$serverUser = "ubuntu"         # 服務器用戶名
```

### 關鍵文件配置

在 `全自動部署-完整版.ps1` 中修改：

```powershell
$criticalFiles = @(
    "api/routers/chats.py",
    "api/main.py"
    # 可以添加更多關鍵文件
)
```

---

## 🔧 故障排除

### 問題 1: 推送失敗

**原因**:
- GitHub 認證問題
- 網絡連接問題
- 遠程倉庫權限問題

**解決方案**:
1. 設置 GitHub Personal Access Token
2. 檢查網絡連接
3. 檢查倉庫權限

---

### 問題 2: 無法連接到服務器

**原因**:
- SSH 連接問題
- 服務器 IP 地址錯誤
- 服務器用戶名錯誤

**解決方案**:
1. 檢查 SSH 連接：`ssh ubuntu@165.154.254.99`
2. 確認服務器 IP 地址
3. 確認服務器用戶名

---

### 問題 3: 服務啟動失敗

**原因**:
- Python 語法錯誤
- 導入錯誤
- 依賴缺失

**解決方案**:
1. 查看錯誤日誌：`sudo journalctl -u luckyred-api -n 50`
2. 檢查 Python 語法
3. 檢查導入路徑
4. 安裝缺失的依賴

---

## 📞 需要協助

如果遇到問題，請：

1. 查看生成的報告文件
2. 檢查錯誤日誌
3. 查看服務器狀態

---

## 🎯 改進建議

### 已完成
- ✅ 自動檢查關鍵文件是否在 Git 中
- ✅ 自動驗證服務器文件狀態
- ✅ 自動執行服務器更新
- ✅ 生成詳細報告

### 未來改進
- ⚠️ 自動修復常見錯誤
- ⚠️ 自動回滾機制
- ⚠️ 自動通知機制
- ⚠️ CI/CD 集成

---

## 📝 注意事項

1. **首次使用**:
   - 確保已配置 SSH 密鑰或密碼
   - 確保有 GitHub 推送權限

2. **執行前**:
   - 確保本地代碼已保存
   - 確保網絡連接正常

3. **執行後**:
   - 查看生成的報告
   - 驗證服務是否正常運行
   - 測試相關功能

---

**祝使用愉快！**

